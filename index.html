<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Family Hub â€” Statistika</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --bg-1: linear-gradient(180deg,#071022,#04101a);
    --card: rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.6);
    --accent: #06b6d4; /* sky-400 */
    --danger: #fb7185; /* red-400 */
    --ok: #34d399; /* emerald-400 */
  }
  html,body{height:100%}
  body{
    margin:0;
    min-height:100%;
    background:var(--bg-1);
    color:#fff;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* main container centered with phone-like width */
  .app {
    max-width:420px;
    margin:18px auto 96px;
    padding:18px;
  }

  .card {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius:16px;
    padding:14px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }

  .nav {
    position:fixed;
    bottom:12px;
    left:50%;
    transform:translateX(-50%);
    width: min(420px, calc(100% - 24px));
    background:rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.04);
    backdrop-filter: blur(6px);
    padding:8px;
    border-radius:14px;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:6px;
    z-index:40;
  }

  .nav button {
    background:transparent;
    border:0;
    color:var(--muted);
    font-weight:600;
    padding:8px 4px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    cursor:pointer;
  }

  .nav button.active { color:var(--accent); }

  input, textarea {
    width:100%;
    box-sizing:border-box;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.04);
    background:rgba(255,255,255,0.02);
    color: #fff;
    outline: none;
  }
  input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.45); }

  .btn {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:12px 14px;
    border-radius:12px;
    border:0;
    cursor:pointer;
    font-weight:700;
  }

  .btn-primary { background: linear-gradient(90deg,#06b6d4,#3b82f6); color:#021328; }
  .btn-danger { background: linear-gradient(90deg,#fb7185,#ef4444); color:white; }
  .btn-ghost { background: transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

  .list-item { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px; border-radius:12px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); }
  .muted { color: rgba(255,255,255,0.6); font-size:13px; }
  .small { font-size:13px; color:rgba(255,255,255,0.7); }

  /* responsive top spacing so nav doesn't overlap content */
  .bottom-space { height:84px; }
</style>
</head>
<body>
  <div class="app">
    <header class="mb-4">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <h1 style="margin:0;font-size:20px;font-weight:800;">ğŸ’¸ Family Hub</h1>
          <div class="muted small">Oilaviy xarajatlar â€” oson va tez</div>
        </div>
        <div style="text-align:right">
          <div id="userName" class="small muted">â€”</div>
          <div id="userId" class="muted" style="font-family:monospace;font-size:12px"></div>
        </div>
      </div>
    </header>

    <!-- ADD -->
    <section id="tab-add" class="card mb-4">
      <h2 style="margin:0 0 10px 0;font-weight:800">â• Xarajat qoâ€˜shish</h2>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="amount" type="number" placeholder="Summa (masalan 12000)">
        <input id="cat" type="text" placeholder="Nima olindi?">
      </div>
      <div style="display:flex;gap:8px">
        <button id="saveBtn" class="btn btn-primary" onclick="addExpense()">ğŸ’¾ Saqlash</button>
        <button class="btn btn-ghost" onclick="openTab('stats')">ğŸ“Š Statistika</button>
      </div>
    </section>

    <!-- STATS -->
    <section id="tab-stats" class="card mb-4 hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <h3 style="margin:0;font-weight:800">ğŸ“Š Statistika</h3>
          <div class="muted small">Bugun va shu oy jami</div>
        </div>
        <div style="text-align:right">
          <div class="small muted">Bugun</div>
          <div id="stToday" style="font-weight:800;font-size:16px">0</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div style="flex:1" class="small muted">Bu oy</div>
        <div style="width:120px;text-align:right;font-weight:800" id="stMonth">0</div>
      </div>

      <div style="height:8px"></div>
      <div id="history" style="display:flex;flex-direction:column;gap:10px"></div>
    </section>

    <!-- SEND -->
    <section id="tab-send" class="card mb-4 hidden">
      <h3 style="margin:0 0 8px 0;font-weight:800">âœ‰ï¸ Oilaga xabar</h3>
      <textarea id="msg" rows="4" placeholder="Xabar matni..."></textarea>
      <div style="height:10px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="sendMessage()">ğŸ“¤ Yuborish</button>
        <button class="btn btn-ghost" onclick="openTab('family')">ğŸ‘¥ Oila</button>
      </div>
    </section>

    <!-- FAMILY -->
    <section id="tab-family" class="card mb-4 hidden">
      <h3 style="margin:0 0 8px 0;font-weight:800">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Oila boshqaruvi</h3>

      <div id="connectBlock">
        <input id="connectId" type="number" placeholder="Oila boshligâ€˜i ID (raqam)">
        <div style="height:8px"></div>
        <button class="btn btn-primary" onclick="connectFamily()">ğŸ”— Ulanish soâ€˜rash</button>
        <div style="height:8px"></div>
        <button class="btn btn-ghost" onclick="shareInvite()">ğŸ“¤ Oilani ulash (kontakt)</button>
      </div>

      <div id="leaveBlock" class="hidden">
        <div style="margin:10px 0" class="muted">Siz hozir oiladasiz</div>
        <button class="btn btn-danger" onclick="confirmLeave()">ğŸšª Oiladan chiqish</button>
      </div>
    </section>

    <div class="bottom-space"></div>
  </div>

  <!-- bottom nav -->
  <nav class="nav" role="navigation" aria-label="Main">
    <button id="nav-add" onclick="openTab('add')" class="active">â•<div style="font-size:12px">Qoâ€˜shish</div></button>
    <button id="nav-stats" onclick="openTab('stats')">ğŸ“Š<div style="font-size:12px">Stat</div></button>
    <button id="nav-send" onclick="openTab('send')">âœ‰ï¸<div style="font-size:12px">Xabar</div></button>
    <button id="nav-family" onclick="openTab('family')">ğŸ‘¥<div style="font-size:12px">Oila</div></button>
  </nav>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); }

  const API_URL = "https://asik.windowsnoutbook.workers.dev"; // <-- agar boshqacha bo'lsa o'zgartir

  // current user info from Telegram WebApp (safe)
  const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : { id: "test_user", first_name: "Test" };
  document.getElementById("userName").innerText = user.first_name || "â€”";
  document.getElementById("userId").innerText = user.id ? `ID: ${user.id}` : "";

  // utility: safe API caller with error handling
  async function api(path, body) {
    try {
      const res = await fetch(API_URL + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        alert("Server xatosi: " + txt);
        throw new Error("Server error");
      }
      return await res.json().catch(()=> ({}));
    } catch (e) {
      alert("Internet yoki API xatosi: " + (e.message || e));
      throw e;
    }
  }

  // tabs
  function openTab(name) {
    ["add","stats","send","family"].forEach(t => {
      const el = document.getElementById("tab-" + t);
      el.classList.toggle("hidden", t !== name);
      // nav active
      document.getElementById("nav-" + t).classList.toggle("active", t === name);
    });

    if (name === "stats") loadStats();
    if (name === "family") refreshFamilyState();
  }

  // add expense
  async function addExpense() {
    const amt = document.getElementById("amount").value.trim();
    const cat = document.getElementById("cat").value.trim() || "noma'lum";
    if (!amt) { alert("Summa kiriting"); return; }
    document.getElementById("saveBtn").disabled = true;
    try {
      await api("/api/add", { userId: String(user.id), userName: user.first_name, amount: amt, cat });
      tg?.showAlert?.("âœ… Saqlandi");
      document.getElementById("amount").value = "";
      document.getElementById("cat").value = "";
      loadStats(); // yangilash
    } catch(e) {
      // error shown in api()
    } finally {
      document.getElementById("saveBtn").disabled = false;
    }
  }

  // send family message
  async function sendMessage() {
    const text = document.getElementById("msg").value.trim();
    if (!text) { alert("Xabar yozing"); return; }
    try {
      await api("/api/send", { userId: String(user.id), userName: user.first_name, text });
      tg?.showAlert?.("âœ‰ï¸ Yuborildi");
      document.getElementById("msg").value = "";
    } catch (e) {}
  }

  // connect from app (by entering owner id)
  async function connectFamily() {
    const target = document.getElementById("connectId").value.trim();
    if (!target) { alert("Oila boshligâ€˜i ID kiriting"); return; }
    try {
      await api("/api/connect", { userId: String(user.id), userName: user.first_name, targetId: target });
      tg?.showAlert?.("ğŸ“¨ Soâ€˜rov yuborildi");
    } catch (e) {}
  }

  // share invite via contact (opens share sheet)
  function shareInvite() {
    const text = `Ulanish uchun botga /connect ${user.id} deb yuboring`;
    const url = "https://t.me/share/url?text=" + encodeURIComponent(text);
    window.open(url, "_blank");
  }

  // leave family (confirm then call)
  async function confirmLeave() {
    const ok = tg?.showConfirm ? tg.showConfirm("Oiladan chiqishni xohlaysizmi?") : confirm("Oiladan chiqishni xohlaysizmi?");
    // tg.showConfirm returns boolean synchronously? If not, fallback to window.confirm
    // For compatibility, if tg.showConfirm returns a Promise-like, handle that:
    if (ok && typeof ok.then === "function") {
      ok.then(async res => { if (res) await leaveFamily(); });
    } else {
      if (ok) await leaveFamily();
    }
  }
  async function leaveFamily() {
    try {
      await api("/api/unc", { userId: String(user.id) });
      tg?.showAlert?.("ğŸšª Chiqding");
      refreshFamilyState();
    } catch (e) {}
  }

  // family state: show connect UI or leave UI
  async function refreshFamilyState() {
    try {
      const data = await api("/api/stats", { userId: String(user.id) });
      const mineCount = data.filter(x => x.name === user.first_name).length;
      const total = data.length;
      const inFamily = total > mineCount;
      document.getElementById("connectBlock").classList.toggle("hidden", inFamily);
      document.getElementById("leaveBlock").classList.toggle("hidden", !inFamily);
    } catch (e) {}
  }

  // stats: load list and totals
  async function loadStats() {
    try {
      const data = await api("/api/stats", { userId: String(user.id) });
      const now = new Date();
      let today = 0, month = 0;
      const container = document.getElementById("history");
      container.innerHTML = "";

      // sort desc
      data.sort((a,b)=>b.id - a.id);

      for (const x of data) {
        const d = new Date(x.id);
        const amount = Number(x.amount) || 0;
        if (d.toDateString() === now.toDateString()) today += amount;
        if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) month += amount;

        // item node
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML = `
          <div style="min-width:0">
            <div style="font-weight:700">${escapeHtml(x.cat)}</div>
            <div class="muted small">${formatDate(d)} â€¢ ${escapeHtml(x.name)}</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="font-weight:800">${amount.toLocaleString()}</div>
            <button class="btn" style="background:transparent;padding:6px;border-radius:8px" title="O'chirish" onclick="confirmDelete(${x.id})">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18" stroke="#fb7185" stroke-width="2" stroke-linecap="round"/><path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="#fb7185" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </div>
        `;
        container.appendChild(item);
      }

      document.getElementById("stToday").innerText = today.toLocaleString();
      document.getElementById("stMonth").innerText = month.toLocaleString();
    } catch (e) {
      // handled in api()
    }
  }

  // confirm and delete
  function confirmDelete(id) {
    const ok = tg?.showConfirm ? tg.showConfirm("Ushbu xarajatni oâ€˜chirilsinmi?") : confirm("Ushbu xarajat oâ€˜chirilsinmi?");
    if (ok && typeof ok.then === "function") {
      ok.then(async res => { if (res) await deleteExpense(id); });
    } else {
      if (ok) deleteExpense(id);
    }
  }
  async function deleteExpense(id) {
    try {
      await api("/api/delete", { userId: String(user.id), id });
      tg?.showAlert?.("ğŸ—‘ O'chirildi");
      loadStats();
    } catch (e) {}
  }

  // small helpers
  function formatDate(d) {
    try {
      return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) + " " + d.toLocaleDateString();
    } catch (e) { return d.toString(); }
  }
  function escapeHtml(s) {
    if (!s) return "";
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]);
  }

  // initial
  (async ()=>{
    // open default tab
    openTab("add");

    // try to refresh family state and stats
    await refreshFamilyState();
    // preload stats if needed:
    // await loadStats();
  })();
</script>
</body>
</html>
