<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ASik App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
  :root {
    --bg-color: #000000;
    --card-bg: #1c1c1e;
    --card-bg-active: #2c2c2e;
    --primary: #0A84FF;
    --danger: #FF453A;
    --text-primary: #ffffff;
    --text-secondary: #8E8E93;
    --separator: #38383A;
    --radius: 16px;
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    margin: 0;
    padding-bottom: 90px;
  }

  .modern-input {
    background: var(--card-bg);
    border: 1px solid transparent;
    border-radius: 12px;
    padding: 16px;
    font-size: 17px;
    color: white;
    width: 100%;
    transition: all 0.2s ease;
    outline: none;
  }
  .modern-input:focus {
    background: var(--card-bg-active);
    border-color: var(--primary);
  }

  .glass-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }

  .btn-action {
    background: var(--primary);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.1s;
    border: none;
    width: 100%;
  }
  .btn-action:active { transform: scale(0.98); opacity: 0.9; }
  .btn-danger { background: var(--danger); }
  .btn-ghost { background: var(--card-bg-active); color: var(--primary); }

  .nav-bar {
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: rgba(28, 28, 30, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 10px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    border: 0.5px solid rgba(255,255,255,0.1);
    z-index: 100;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .nav-item {
    color: var(--text-secondary);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 500;
    padding: 8px;
    border-radius: 12px;
    background: transparent;
    border: none;
    transition: all 0.2s;
  }
  .nav-item i { font-size: 24px; margin-bottom: 2px; }
  .nav-item.active { color: var(--primary); background: rgba(10, 132, 255, 0.1); }

  .profile-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--card-bg-active);
    overflow: hidden;
    border: 2px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .list-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .list-row:last-child { border-bottom: none; }

  .hidden { display: none !important; }

  h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
  h2 { font-size: 20px; font-weight: 700; margin-bottom: 15px; }
  .subtitle { font-size: 13px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block;}

  /* LOCK overlay */
  .lock-wrap {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .lock-card {
    width: 100%;
    max-width: 420px;
    background: var(--card-bg);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px;
    padding: 22px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.55);
  }
  .lock-title {
    font-weight: 800;
    font-size: 18px;
    margin: 0 0 8px 0;
  }
  .lock-sub {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0 0 16px 0;
    line-height: 1.35;
  }

  /* ---------------- SKELETON LOADING (YouTube-like) ---------------- */
  .skeleton {
    background: var(--card-bg-active);
    position: relative;
    overflow: hidden;
  }
  .skeleton::after {
    content: "";
    position: absolute;
    inset: 0;
    transform: translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
    animation: shimmer 1.15s infinite;
  }
  .skeleton-circle { border-radius: 9999px; }

  @keyframes shimmer {
    100% { transform: translateX(100%); }
  }

  @media (prefers-reduced-motion: reduce) {
    .skeleton::after { animation: none; }
  }
</style>
</head>
<body>

<div class="p-5 max-w-md mx-auto">

  <!-- HEADER -->
  <header class="flex justify-between items-center mb-6">
    <div>
      <div class="text-sm text-gray-400 font-medium mb-1">ASik</div>
      <h1>Xarajatlar</h1>
    </div>
    <div class="profile-avatar" onclick="openTab('family')">
      <img id="userAvatar" src="" alt="User" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'ph-bold ph-user\'></i>'">
    </div>
  </header>

  <!-- ADD EXPENSE -->
  <section id="tab-add" class="animate-fade">
    <div class="glass-card">
      <span class="subtitle">Yangi qo'shish</span>
      <div class="flex flex-col gap-3">
        <input id="amount" type="number" class="modern-input text-2xl font-bold" placeholder="0 so'm">
        <input id="cat" type="text" class="modern-input" placeholder="Nima olindi? (Non, Go'sht)">
        <button onclick="addExpense()" class="btn-action mt-2">
          <i class="ph-bold ph-plus"></i> Qo'shish
        </button>
      </div>
    </div>

    <div class="glass-card">
      <span class="subtitle">Bugungi holat</span>
      <div class="flex justify-between items-end">
        <div>
          <div class="text-gray-400 text-sm">Bugun sarflandi</div>
          <div id="quickStatsToday" class="text-2xl font-bold text-white mt-1">0</div>
        </div>
        <button onclick="openTab('stats')" class="text-blue-500 font-medium text-sm bg-transparent border-0">To'liq &rarr;</button>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="tab-stats" class="hidden">
    <div class="glass-card">
      <span class="subtitle">Umumiy hisobot</span>
      <div class="flex justify-between items-center mb-4">
        <span class="text-gray-400">Jami (Oy):</span>
        <span id="stMonth" class="text-2xl font-bold text-blue-500">0</span>
      </div>
      <div id="history" class="flex flex-col gap-1"></div>
    </div>

    <h2 class="mt-6 px-1">Tarix</h2>
    <div id="calendar" class="flex flex-col gap-3"></div>
  </section>

  <!-- FAMILY SETTINGS -->
  <section id="tab-family" class="hidden">
    <div class="glass-card text-center">
      <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 mx-auto flex items-center justify-center mb-3 text-3xl text-white">
        <i class="ph-bold ph-house"></i>
      </div>
      <h2 id="familyName" class="m-0 text-xl">Mening Oilam</h2>
      <div class="text-gray-400 text-sm mt-1" id="familyIdDisplay">ID: ...</div>
    </div>

    <div class="mb-2 px-1 flex justify-between items-end">
      <span class="subtitle mb-0">Ishtirokchilar</span>
    </div>

    <div class="glass-card p-0 overflow-hidden">
      <div id="familyList" class="divide-y divide-gray-800"></div>
    </div>

    <div class="glass-card">
      <span class="subtitle">Boshqaruv</span>
      <div class="flex flex-col gap-3">
        <div id="connectBlock">
          <p class="text-sm text-gray-400 mb-2">Boshqa oilaga qo'shilish uchun ID kiriting:</p>
          <div class="flex gap-2">
            <input id="connectId" type="number" class="modern-input py-2" placeholder="Oila ID">
            <button class="btn-action w-auto px-4" onclick="connectFamily()">
              <i class="ph-bold ph-arrow-right"></i>
            </button>
          </div>
        </div>

        <button class="btn-action btn-ghost w-full justify-center mt-2" onclick="shareInvite()">
          <i class="ph-bold ph-share-network"></i> Taklif havolasi
        </button>

        <button id="leaveBtn" class="btn-action btn-danger w-full justify-center hidden mt-2" onclick="confirmLeave()">
          <i class="ph-bold ph-sign-out"></i> Oiladan chiqish
        </button>
      </div>
    </div>
  </section>

  <!-- SEND MESSAGE -->
  <section id="tab-send" class="hidden">
    <div class="glass-card">
      <span class="subtitle">Xabar yuborish</span>
      <textarea id="msg" rows="4" class="modern-input mb-3" placeholder="Oila a'zolariga xabar qoldiring..."></textarea>
      <button class="btn-action" onclick="sendMessage()">
        <i class="ph-bold ph-paper-plane-right"></i> Yuborish
      </button>
    </div>
  </section>

</div>

<!-- NAVIGATION -->
<nav class="nav-bar">
  <button id="nav-add" class="nav-item active" onclick="openTab('add')">
    <i class="ph-fill ph-plus-circle"></i>
    <span>Qo'shish</span>
  </button>
  <button id="nav-stats" class="nav-item" onclick="openTab('stats')">
    <i class="ph-fill ph-chart-bar"></i>
    <span>Hisobot</span>
  </button>
  <button id="nav-send" class="nav-item" onclick="openTab('send')">
    <i class="ph-fill ph-chat-circle-text"></i>
    <span>Xabar</span>
  </button>
  <button id="nav-family" class="nav-item" onclick="openTab('family')">
    <i class="ph-fill ph-users-three"></i>
    <span>Oila</span>
  </button>
</nav>

<script>
/** ---------------- CONFIG / INIT ---------------- */
const tg = window.Telegram?.WebApp;

// Bot url
const BOT_URL = "https://t.me/ASikkeeper_bot";

// ❗ Faqat Telegram ichida ishlasin (oddiy brauzer blok)
const INIT_DATA = tg?.initData || "";
if (!tg || !INIT_DATA) {
  document.body.innerHTML = `
    <div class="lock-wrap">
      <div class="lock-card">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-12 h-12 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-2xl shrink-0">
            <i class="ph-bold ph-telegram-logo"></i>
          </div>
          <div>
            <div class="lock-title">Faqat Telegram ichida</div>
            <div class="text-xs text-gray-500">Bu sahifa oddiy brauzerda ishlamaydi</div>
          </div>
        </div>

        <p class="lock-sub">
          Mini App faqat Telegram orqali ochiladi. Botni ochib, u yerdan Mini App’ni ishga tushir.
        </p>

        <a class="btn-action" href="${BOT_URL}" target="_blank" rel="noreferrer">
          <i class="ph-bold ph-telegram-logo"></i> Botni ochish
        </a>
      </div>
    </div>
  `;
  throw new Error("Telegram only");
}

tg.expand();
tg.setHeaderColor('#000000');
tg.setBackgroundColor('#000000');

// Worker URL
const API_URL = "https://asik.windowsnoutbook.workers.dev";

// Telegram user or mock
const user = tg?.initDataUnsafe?.user || { id: "test_999", first_name: "Test", photo_url: "" };

// Avatar
const avatarEl = document.getElementById("userAvatar");
if (user.photo_url) avatarEl.src = user.photo_url;
else {
  avatarEl.style.display = "none";
  avatarEl.parentElement.innerHTML = '<i class="ph-bold ph-user text-white text-xl"></i>';
}

let currentFamilyData = null;
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

/** ---------------- SKELETON HELPERS ---------------- */
function skeletonLine(w, h, r = 10) {
  return `<div class="skeleton" style="width:${w};height:${h};border-radius:${r}px;"></div>`;
}
function skeletonCircle(size) {
  return `<div class="skeleton skeleton-circle" style="width:${size};height:${size};"></div>`;
}
function setSkeleton(el, html) {
  if (!el) return;
  if (el.dataset.prevHtml === undefined) el.dataset.prevHtml = el.innerHTML;
  el.innerHTML = html;
}
function restoreSkeleton(el) {
  if (!el) return;
  if (el.dataset.prevHtml !== undefined) {
    el.innerHTML = el.dataset.prevHtml;
    delete el.dataset.prevHtml;
  }
}

function showQuickStatsSkeleton() {
  const el = document.getElementById("quickStatsToday");
  if (!el) return;
  setSkeleton(el, skeletonLine("140px", "28px", 12));
}

function showStatsSkeleton() {
  const stMonth = document.getElementById("stMonth");
  const history = document.getElementById("history");
  const calendar = document.getElementById("calendar");

  if (stMonth) setSkeleton(stMonth, skeletonLine("110px", "28px", 12));

  if (history) {
    history.innerHTML = Array.from({length: 5}).map(() => `
      <div class="list-row">
        <div class="flex items-center gap-3">
          ${skeletonCircle("32px")}
          <div class="flex flex-col gap-2">
            ${skeletonLine("160px","12px",6)}
            ${skeletonLine("120px","10px",6)}
          </div>
        </div>
        ${skeletonLine("70px","14px",7)}
      </div>
    `).join("");
  }

  if (calendar) {
    calendar.innerHTML = Array.from({length: 3}).map(() => `
      <div class="glass-card !p-4">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700">
          ${skeletonLine("130px","14px",7)}
          ${skeletonLine("90px","14px",7)}
        </div>
        ${Array.from({length: 3}).map(() => `
          <div class="flex justify-between text-sm mb-2">
            ${skeletonLine("170px","12px",6)}
            ${skeletonLine("70px","12px",6)}
          </div>
        `).join("")}
      </div>
    `).join("");
  }
}

function showFamilySkeleton() {
  const nameEl = document.getElementById("familyName");
  const idEl = document.getElementById("familyIdDisplay");
  const listEl = document.getElementById("familyList");

  if (nameEl) setSkeleton(nameEl, `<div class="skeleton" style="width:160px;height:20px;border-radius:10px;margin:0 auto;"></div>`);
  if (idEl) setSkeleton(idEl, `<div class="skeleton" style="width:140px;height:12px;border-radius:6px;margin:8px auto 0;"></div>`);

  if (!listEl) return;
  if (listEl.dataset.prevHtml === undefined) listEl.dataset.prevHtml = listEl.innerHTML;

  listEl.innerHTML = `
    <div class="flex items-center justify-between p-4 bg-blue-900/20">
      <div class="flex items-center gap-3">
        ${skeletonCircle("40px")}
        <div class="flex flex-col gap-2">
          ${skeletonLine("200px","12px",6)}
          ${skeletonLine("90px","10px",6)}
        </div>
      </div>
    </div>
    ${Array.from({length: 3}).map(() => `
      <div class="flex items-center justify-between p-4">
        <div class="flex items-center gap-3">
          ${skeletonCircle("40px")}
          <div class="flex flex-col gap-2">
            ${skeletonLine("150px","12px",6)}
            ${skeletonLine("110px","10px",6)}
          </div>
        </div>
        ${skeletonCircle("32px")}
      </div>
    `).join("")}
  `;
}

/** ---------------- UI: LOCK (not registered) ---------------- */
let locked = false;
function showNotRegistered() {
  if (locked) return;
  locked = true;

  const text = "Botga qaytadan /start yubor.";

  const wrap = document.createElement("div");
  wrap.className = "lock-wrap";
  wrap.innerHTML = `
    <div class="lock-card">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-300 flex items-center justify-center text-2xl shrink-0">
          <i class="ph-bold ph-info"></i>
        </div>
        <div>
          <div class="lock-title">Ro'yxatdan o'tmagan</div>
          <div class="text-xs text-gray-500">UserID: ${escapeHtml(String(user.id))}</div>
        </div>
      </div>

      <p class="lock-sub">${escapeHtml(text)}</p>

      <button class="btn-action" id="openBotBtn">
        <i class="ph-bold ph-telegram-logo"></i> Botni ochish
      </button>

      <button class="btn-action btn-ghost mt-3" id="reloadBtn">
        <i class="ph-bold ph-arrow-clockwise"></i> Qayta tekshirish
      </button>
    </div>
  `;
  document.body.appendChild(wrap);

  document.getElementById("openBotBtn").onclick = () => {
    if (tg?.openTelegramLink) tg.openTelegramLink(BOT_URL);
    else window.open(BOT_URL, "_blank");
  };
  document.getElementById("reloadBtn").onclick = () => location.reload();

  tg?.showAlert?.(text);
}

/** ---------------- STABLE API ---------------- */
async function api(path, body, { timeoutMs = 12000, retries = 1 } = {}) {
  const btns = document.querySelectorAll("button");
  btns.forEach(b => b.style.opacity = "0.7");

  try {
    let lastErr = null;

    for (let attempt = 0; attempt <= retries; attempt++) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const r = await fetch(API_URL + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
          signal: controller.signal
        });

        const text = await r.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; }
        catch { data = { ok:false, error:"non_json", message:"Server noto'g'ri javob berdi", raw:text }; }

        clearTimeout(timer);

        if (!r.ok || (data && data.ok === false)) {
          const msg = data?.message || data?.error || `HTTP ${r.status}`;

          if (data?.error === "not_registered") {
            showNotRegistered();
            return null;
          }
          if (data?.error === "target_not_found") {
            tg?.showAlert?.("Xatolik: " + (data?.message || "Bunday foydalanuvchi botda mavjud emas"));
            return null;
          }

          tg?.showAlert?.("Xatolik: " + msg);
          return null;
        }

        return data;
      } catch (e) {
        clearTimeout(timer);
        lastErr = e;
        if (attempt < retries) { await sleep(350 * (attempt + 1)); continue; }
        const msg = e?.name === "AbortError" ? "Timeout. Worker javob bermadi." : (e.message || "Unknown error");
        tg?.showAlert?.("Xatolik: " + msg);
        return null;
      }
    }

    throw lastErr;
  } finally {
    btns.forEach(b => b.style.opacity = "1");
  }
}

/** ---------------- NAVIGATION ---------------- */
function openTab(n){
  ["add","stats","send","family"].forEach(t=>{
    document.getElementById("tab-"+t).classList.toggle("hidden",t!==n);
    document.getElementById("nav-"+t)?.classList?.toggle("active",t===n);
  });

  const titles = { add: "Xarajatlar", stats: "Hisobot", send: "Xat yozish", family: "Oila Sozlamalari" };
  document.querySelector("h1").innerText = titles[n] || "ASik";

  if(n==="stats") loadStats();
  if(n==="family") refreshFamily();
  if(n==="add") loadQuickStats();

  window.scrollTo({top: 0, behavior: "smooth"});
}

/** ---------------- ADD ---------------- */
async function addExpense(){
  const amt=document.getElementById("amount").value.trim();
  const cat=document.getElementById("cat").value.trim()||"Boshqa";
  if(!amt) return tg?.showAlert?.("Summani kiriting!");

  const res = await api("/api/add",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    amount:amt,
    cat
  });

  if(!res?.ok) return;

  tg?.HapticFeedback?.notificationOccurred?.("success");
  tg?.showAlert?.("✅ Saqlandi");

  document.getElementById("amount").value="";
  document.getElementById("cat").value="";
  loadQuickStats();
}

async function loadQuickStats() {
  const el = document.getElementById("quickStatsToday");
  const prev = el ? el.innerHTML : "";
  showQuickStatsSkeleton();

  const data = await api("/api/stats",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });

  if(!Array.isArray(data)) {
    if (el) el.innerHTML = prev;
    return;
  }

  const now = new Date();
  let today = 0;
  for (const x of data) {
    const ts = Number(x.createdAt || x.id);
    if (!ts) continue;
    const d = new Date(ts);
    if(d.toDateString() === now.toDateString()) today += (Number(x.amount)||0);
  }

  if (el) {
    delete el.dataset.prevHtml;
    el.innerText = today.toLocaleString() + " so'm";
  }
}

/** ---------------- STATS ---------------- */
async function loadStats(){
  showStatsSkeleton();

  const data = await api("/api/stats",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });

  const history = document.getElementById("history");
  const calendar = document.getElementById("calendar");
  history.innerHTML = ""; calendar.innerHTML = "";

  if(!Array.isArray(data) || !data.length) {
    history.innerHTML = "<div class='text-center text-gray-500 py-4'>Hozircha xarajat yo'q</div>";
    document.getElementById("stMonth").innerText = "0 so'm";
    return;
  }

  const now = new Date();
  let month = 0;

  data.sort((a,b)=>Number(b.id)-Number(a.id));
  const byDate={};

  data.slice(0, 5).forEach(x => {
    const d = new Date(Number(x.createdAt || x.id));
    const div = document.createElement("div");
    div.className = "list-row";
    div.innerHTML = `
      <div class="flex items-center gap-3 min-w-0">
        <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-blue-500 shrink-0">
          <i class="ph-bold ph-shopping-bag leading-none"></i>
        </div>
        <div class="min-w-0">
          <div class="font-semibold text-sm truncate">${escapeHtml(x.cat || "noma'lum")}</div>
          <div class="text-xs text-gray-500 truncate">${escapeHtml(x.name || "User")} • ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</div>
        </div>
      </div>
      <div class="font-bold text-white shrink-0">${Number(x.amount||0).toLocaleString()}</div>
    `;
    history.appendChild(div);
  });

  for(const x of data){
    const d=new Date(Number(x.createdAt||x.id));
    const key=d.toISOString().split("T")[0];
    const amount=Number(x.amount)||0;

    if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()) month+=amount;

    if(!byDate[key]) byDate[key]=[];
    byDate[key].push(x);
  }

  const days = Object.keys(byDate).sort((a,b)=>a<b?1:-1);
  for(const day of days){
    const block=document.createElement("div");
    block.className="glass-card !p-4";

    const d=new Date(day+"T00:00:00");
    let sum=0;
    byDate[day].forEach(x=>sum+=Number(x.amount)||0);

    let html=`<div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700">
      <span class="font-bold text-gray-300">${d.toLocaleDateString()}</span>
      <span class="text-blue-400 font-bold">${sum.toLocaleString()}</span>
    </div>`;

    for(const x of byDate[day]){
      html+=`<div class="flex justify-between text-sm mb-2 last:mb-0 gap-3">
        <span class="text-gray-400 truncate">${escapeHtml(x.cat || "noma'lum")}
          <span class="text-xs opacity-50">(${escapeHtml(x.name || "")})</span>
        </span>
        <span class="shrink-0">${Number(x.amount||0).toLocaleString()}</span>
      </div>`;
    }
    block.innerHTML=html;
    calendar.appendChild(block);
  }

  document.getElementById("stMonth").innerText = month.toLocaleString() + " so'm";
}

/** ---------------- FAMILY ---------------- */
async function refreshFamily(){
  const nameEl = document.getElementById("familyName");
  const idEl = document.getElementById("familyIdDisplay");
  const listEl = document.getElementById("familyList");

  if (nameEl && nameEl.dataset.prevHtml === undefined) nameEl.dataset.prevHtml = nameEl.innerHTML;
  if (idEl && idEl.dataset.prevHtml === undefined) idEl.dataset.prevHtml = idEl.innerHTML;
  if (listEl && listEl.dataset.prevHtml === undefined) listEl.dataset.prevHtml = listEl.innerHTML;

  showFamilySkeleton();

  const f = await api("/api/family",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });
  if (!f) {
    restoreSkeleton(nameEl);
    restoreSkeleton(idEl);
    restoreSkeleton(listEl);
    return;
  }

  if (nameEl) delete nameEl.dataset.prevHtml;
  if (idEl) delete idEl.dataset.prevHtml;
  if (listEl) delete listEl.dataset.prevHtml;

  currentFamilyData = f;

  const list = document.getElementById("familyList");
  list.innerHTML = "";

  const leader = f.leader || { id:"", name:"Leader", photo:"" };
  const members = Array.isArray(f.members) ? f.members : [];

  const isLeader = (String(leader.id) === String(user.id));

  document.getElementById("familyName").innerText = isLeader ? "Mening Oilam" : "Oila";
  document.getElementById("familyIdDisplay").innerText = "Oila ID: " + leader.id;

  document.getElementById("leaveBtn").classList.toggle("hidden", isLeader);

  const avatarHtml = (photo) => {
    if (photo) return `<img src="${photo}" class="w-10 h-10 rounded-full object-cover shrink-0" />`;
    return `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-300 shrink-0">
              <i class="ph-bold ph-user leading-none"></i>
            </div>`;
  };

  // leader row
  const leaderRow = document.createElement("div");
  leaderRow.className = "flex items-center justify-between p-4 bg-blue-900/20";
  leaderRow.innerHTML = `
    <div class="flex items-center gap-3 min-w-0">
      <div class="relative shrink-0">
        ${avatarHtml(leader.photo)}
        <div class="absolute -right-1 -bottom-1 w-5 h-5 rounded-full bg-yellow-500 flex items-center justify-center shrink-0">
          <i class="ph-fill ph-crown text-black text-xs leading-none"></i>
        </div>
      </div>
      <div class="min-w-0">
        <div class="font-bold text-white truncate">${escapeHtml(leader.name)} <span class="text-xs text-gray-400">(ID: ${escapeHtml(leader.id)})</span></div>
        <div class="text-xs text-gray-400">Admin</div>
      </div>
    </div>
  `;
  list.appendChild(leaderRow);

  if (!members.length) {
    const empty = document.createElement("div");
    empty.className = "p-4 text-center text-gray-500 text-sm";
    empty.innerText = "Boshqa ishtirokchilar yo'q";
    list.appendChild(empty);
    return;
  }

  for (const m of members) {
    const row = document.createElement("div");
    row.className = "flex items-center justify-between p-4 gap-3";

    const actionBtn = isLeader ? `
      <button onclick="kickMember('${String(m.id)}')" class="w-8 h-8 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center shrink-0">
        <i class="ph-bold ph-trash leading-none"></i>
      </button>` : "";

    row.innerHTML = `
      <div class="flex items-center gap-3 min-w-0">
        ${avatarHtml(m.photo)}
        <div class="min-w-0">
          <div class="font-medium text-white truncate">${escapeHtml(m.name || "User")}</div>
          <div class="text-xs text-gray-500 truncate">ID: ${escapeHtml(String(m.id))}</div>
        </div>
      </div>
      ${actionBtn}
    `;
    list.appendChild(row);
  }
}

async function connectFamily(){
  const id=document.getElementById("connectId").value.trim();
  if(!id) return tg?.showAlert?.("ID raqamini yozing");
  if(id === String(user.id)) return tg?.showAlert?.("O'z IDingizni yozmang");

  const res = await api("/api/connect",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    targetId:id
  });

  if(res?.ok) tg?.showAlert?.("So'rov yuborildi ✅");
}

async function kickMember(targetId) {
  if(!confirm("Bu foydalanuvchini oiladan o'chirmoqchimisiz?")) return;

  const res = await api("/api/kick", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || "",
    targetId: String(targetId)
  });

  if(res?.ok) {
    tg?.showAlert?.("Foydalanuvchi o'chirildi");
    refreshFamily();
  }
}

async function confirmLeave(){
  if(!confirm("Rostan ham oiladan chiqmoqchisiz?")) return;

  const res = await api("/api/leave", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || ""
  });

  if(res?.ok) {
    tg?.showAlert?.("Siz oiladan chiqdingiz");
    location.reload();
  }
}

/** ---------------- SEND ---------------- */
async function sendMessage(){
  const text=document.getElementById("msg").value.trim();
  if(!text) return tg?.showAlert?.("Xabar yozing");

  const res = await api("/api/send",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    text
  });

  if(res?.ok) {
    tg?.showAlert?.("Xabar yuborildi! ✉️");
    document.getElementById("msg").value="";
  }
}

function shareInvite(){
  const text=`ASik ilovasiga ulaning. Mening ID raqamim: ${user.id}`;
  const share = "https://t.me/share/url?text=" + encodeURIComponent(text);
  if(tg?.openTelegramLink) tg.openTelegramLink(share);
  else window.open(share, "_blank");
}

/** ---------------- SAFETY ---------------- */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// Initial load (will show lock if not registered)
loadQuickStats();
</script>
</body>
</html>
