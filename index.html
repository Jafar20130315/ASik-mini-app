<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistika</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{
  background: linear-gradient(180deg,#0f172a,#020617);
  color:white;
  font-family: system-ui;
}

.card{
  background:#0b1220;
  border:1px solid #1e293b;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

input,textarea{
  background:#020617 !important;
  color:white !important;
  border:1px solid #1e293b !important;
}

button{
  transition:.2s;
}
button:active{
  transform:scale(.97);
}
.tab-btn-active{
  color:#38bdf8;
}
</style>

</head>

<body class="p-4 pb-24 select-none">

<h1 class="text-3xl font-bold text-center mb-4">ğŸ’¸ Family Hub</h1>

<!-- ================= TABS ================= -->
<div class="grid grid-cols-2 gap-2 text-center mb-3">
  <button onclick="openTab('add')" id="btn-add" class="p-2 rounded-xl card">â• Qoâ€˜shish</button>
  <button onclick="openTab('stats')" id="btn-stats" class="p-2 rounded-xl card">ğŸ“Š Statistika</button>
  <button onclick="openTab('send')" id="btn-send" class="p-2 rounded-xl card">âœ‰ï¸ Xabar yuborish</button>
  <button onclick="openTab('family')" id="btn-family" class="p-2 rounded-xl card">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Oila</button>
</div>

<!-- ================= ADD ================= -->
<div id="tab-add" class="card p-4 rounded-2xl space-y-3 hidden">

  <h2 class="text-xl font-bold">â• Xarajat qoâ€˜shish</h2>

  <input id="amount" type="number" class="w-full p-3 rounded-xl" placeholder="Summa (masalan 12000)">
  <input id="cat" type="text" class="w-full p-3 rounded-xl" placeholder="Nima olindi?">

  <button onclick="addExpense()" class="w-full p-3 rounded-xl bg-sky-600 font-bold">
    ğŸ’¾ Saqlash
  </button>

</div>

<!-- ================= STATS ================= -->
<div id="tab-stats" class="card p-4 rounded-2xl space-y-3 hidden">

  <h2 class="text-xl font-bold">ğŸ“Š Statistika</h2>

  <div class="flex justify-between bg-black/40 rounded-xl p-3">
    <span>Bugun:</span>
    <span id="stat-today" class="font-bold">0</span>
  </div>

  <div class="flex justify-between bg-black/40 rounded-xl p-3">
    <span>Bu oy:</span>
    <span id="stat-month" class="font-bold">0</span>
  </div>

  <h3 class="font-bold mt-2">Oxirgi xarajatlar</h3>
  <ul id="history" class="space-y-2 text-sm"></ul>

</div>

<!-- ================= SEND ================= -->
<div id="tab-send" class="card p-4 rounded-2xl space-y-3 hidden">

  <h2 class="text-xl font-bold">âœ‰ï¸ Oilaga xabar yuborish</h2>

  <textarea id="msg" rows="4" class="w-full p-3 rounded-xl" placeholder="Xabar matni..."></textarea>

  <button onclick="sendMessage()" class="w-full p-3 rounded-xl bg-emerald-600 font-bold">
    ğŸ“¤ Yuborish
  </button>

</div>

<!-- ================= FAMILY ================= -->
<div id="tab-family" class="card p-4 rounded-2xl space-y-4 hidden">

  <h2 class="text-xl font-bold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Oila boshqaruvi</h2>

  <div id="connect-block">
      <input id="connectId" type="number" class="w-full p-3 rounded-xl" placeholder="Oila boshligâ€˜i ID">

      <button onclick="connectFamily()" class="w-full p-3 rounded-xl bg-blue-600 font-bold">
        ğŸ”— Ulanish soâ€˜rash
      </button>

      <button onclick="shareInvite()" class="w-full p-3 rounded-xl bg-purple-600 font-bold">
        ğŸ“¤ Oilani ulash (kontakt tanlash)
      </button>
  </div>

  <div id="leave-block" class="hidden space-y-3">
      <div class="text-emerald-400 font-bold">
        âœ… Sen hozir oiladasan
      </div>

      <button onclick="leaveFamily()" class="w-full p-3 rounded-xl bg-red-600 font-bold">
        ğŸšª Oiladan chiqish
      </button>
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_URL = "https://asik.windowsnoutbook.workers.dev";

const user = tg.initDataUnsafe.user || { id:"test", first_name:"Test" };

/* ================= TABLAR ================= */

function openTab(name){
  document.querySelectorAll("[id^=tab-]").forEach(e=>e.classList.add("hidden"));
  document.querySelectorAll("[id^=btn-]").forEach(e=>e.classList.remove("tab-btn-active"));

  document.getElementById("tab-"+name).classList.remove("hidden");
  document.getElementById("btn-"+name).classList.add("tab-btn-active");

  if(name==="stats") loadStats();
  if(name==="family") checkFamilyState();
}

openTab("add");

/* ================= API ================= */

async function api(path,data){
  return fetch(API_URL+path,{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify(data)
  }).then(r=>r.json().catch(()=>({})));
}

/* ================= ADD ================= */

async function addExpense(){
  await api("/api/add",{
    userId:user.id,
    userName:user.first_name,
    amount:amount.value,
    cat:cat.value
  });
  tg.showAlert("âœ… Saqlandi");
  amount.value="";
  cat.value="";
}

/* ================= SEND ================= */

async function sendMessage(){
  await api("/api/send",{
    userId:user.id,
    userName:user.first_name,
    text:msg.value
  });
  tg.showAlert("âœ‰ï¸ Yuborildi");
  msg.value="";
}

/* ================= CONNECT ================= */

async function connectFamily(){
  await api("/api/connect",{
    userId:user.id,
    userName:user.first_name,
    targetId:connectId.value
  });
  tg.showAlert("ğŸ“¨ Soâ€˜rov yuborildi");
}

/* share via contacts */

function shareInvite(){

  const text = `Ulanish uchun botga /connect ${user.id} (mono) deb yuboring`;

  const url =
    "https://t.me/share/url?text=" +
    encodeURIComponent(text);

  window.open(url,"_blank");
}

/* ================= LEAVE ================= */

async function leaveFamily(){
  await api("/api/unc",{ userId:user.id });
  tg.showAlert("ğŸšª Chiqding");
  checkFamilyState();
}

/* ================= FAMILY STATUS ================= */

async function checkFamilyState(){

  // juda oddiy usul: agar stats javobida boshqa odamlar ham boâ€˜lsa â†’ oilada
  const data = await api("/api/stats",{ userId:user.id });

  const mine = data.filter(x=>x.name===user.first_name).length;
  const all = data.length;

  if(all>mine){
    // oilada
    document.getElementById("connect-block").classList.add("hidden");
    document.getElementById("leave-block").classList.remove("hidden");
  } else {
    // oilada emas
    document.getElementById("connect-block").classList.remove("hidden");
    document.getElementById("leave-block").classList.add("hidden");
  }
}

/* ================= STATS ================= */

async function loadStats(){

  const data = await api("/api/stats",{ userId:user.id });

  const now = new Date();
  let today=0, month=0;
  let html="";

  data.sort((a,b)=>b.id-a.id).forEach(x=>{
    const d = new Date(x.id);

    if(d.toDateString()===now.toDateString()) today+=Number(x.amount);
    if(d.getMonth()===now.getMonth()) month+=Number(x.amount);

    html+=`
    <li class="bg-black/30 p-2 rounded-xl flex justify-between">
      <span>${x.cat} <span class="text-xs text-sky-400">(${x.name})</span></span>
      <b>${x.amount}</b>
    </li>`;
  });

  document.getElementById("stat-today").innerText=today.toLocaleString();
  document.getElementById("stat-month").innerText=month.toLocaleString();
  document.getElementById("history").innerHTML=html;
}
</script>

</body>
</html>
