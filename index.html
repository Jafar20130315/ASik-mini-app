<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>Family Hub</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{
  background:linear-gradient(180deg,#0f172a,#020617);
  color:white;
  font-family:Inter,system-ui;
}
.card{
  background:#0b1220;
  border:1px solid #1e293b;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}
input,textarea{
  background:#020617 !important;
  color:white !important;
  border:1px solid #1e293b !important;
  border-radius:14px;
}
.navbtn-active{
  color:#38bdf8;
}
</style>
</head>

<body class="p-4 pb-28">

<h1 class="text-3xl font-bold text-center mb-4">ğŸ’¸ Family Hub</h1>

<!-- NAV -->
<div class="fixed bottom-0 left-0 w-full bg-black/50 backdrop-blur-lg border-t border-slate-700 p-2 grid grid-cols-4 text-center">
  <button onclick="openTab('add')" id="nav-add">â•</button>
  <button onclick="openTab('stats')" id="nav-stats">ğŸ“Š</button>
  <button onclick="openTab('send')" id="nav-send">âœ‰ï¸</button>
  <button onclick="openTab('family')" id="nav-family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</button>
</div>

<!-- ADD -->
<div id="tab-add" class="card p-4 space-y-3 hidden">

  <h2 class="font-bold text-xl">â• Xarajat qoâ€˜shish</h2>

  <input id="amount" type="number" placeholder="Summa (12000)">
  <input id="cat" type="text" placeholder="Masalan: Non, Taksi">

  <button onclick="addExpense()" class="w-full bg-sky-600 p-3 rounded-xl font-bold">ğŸ’¾ Saqlash</button>

</div>

<!-- STATS -->
<div id="tab-stats" class="card p-4 space-y-3 hidden">

  <h2 class="font-bold text-xl">ğŸ“Š Statistika</h2>

  <div class="flex justify-between bg-black/40 p-3 rounded-xl">
    <span>Bugun</span><b id="st-today">0</b>
  </div>

  <div class="flex justify-between bg-black/40 p-3 rounded-xl">
    <span>Bu oy</span><b id="st-month">0</b>
  </div>

  <div class="h-px bg-slate-700 my-2"></div>

  <div id="history" class="space-y-2 text-sm"></div>

</div>

<!-- SEND -->
<div id="tab-send" class="card p-4 space-y-3 hidden">

  <h2 class="font-bold text-xl">âœ‰ï¸ Xabar yuborish</h2>

  <textarea id="msg" rows="3" placeholder="Xabar matni..."></textarea>

  <button onclick="sendMessage()" class="w-full bg-emerald-600 p-3 rounded-xl font-bold">
    ğŸ“¤ Yuborish
  </button>

</div>

<!-- FAMILY -->
<div id="tab-family" class="card p-4 space-y-3 hidden">

  <h2 class="font-bold text-xl">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Oila</h2>

  <div id="connect-block">
    <input id="connectId" type="number" placeholder="Oila boshligâ€˜i ID">

    <button onclick="connectFamily()" class="w-full bg-blue-600 p-3 rounded-xl font-bold">
      ğŸ”— Ulanish soâ€˜rash
    </button>

    <button onclick="shareInvite()" class="w-full bg-purple-600 p-3 rounded-xl font-bold">
      ğŸ“¤ Oilani ulash
    </button>
  </div>

  <div id="leave-block" class="hidden">
    <p class="text-emerald-400 font-bold">ğŸ”¥ Sen oiladasan</p>

    <button onclick="leaveFamily()" class="w-full bg-red-600 p-3 rounded-xl font-bold">
      ğŸšª Oiladan chiqish
    </button>
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_URL = "https://asik.windowsnoutbook.workers.dev";

const user = tg.initDataUnsafe.user || { id:"test", first_name:"Test" };

// -------- tabs
function openTab(n){
  document.querySelectorAll("[id^=tab-]").forEach(e=>e.classList.add("hidden"));
  document.querySelectorAll("[id^=nav-]").forEach(e=>e.classList.remove("navbtn-active"));
  document.getElementById("tab-"+n).classList.remove("hidden");
  document.getElementById("nav-"+n).classList.add("navbtn-active");
  if(n==="stats") loadStats();
  if(n==="family") familyState();
}
openTab("add");

// -------- API helper
async function api(p,d){
  const r = await fetch(API_URL+p,{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify(d)
  });
  return r.json();
}

// -------- add
async function addExpense(){
  await api("/api/add",{userId:user.id,userName:user.first_name,amount:amount.value,cat:cat.value});
  tg.showAlert("âœ” Saqlandi");
  amount.value="";cat.value="";
}

// -------- send
async function sendMessage(){
  await api("/api/send",{userId:user.id,userName:user.first_name,text:msg.value});
  tg.showAlert("Yuborildi");
  msg.value="";
}

// -------- connect
async function connectFamily(){
  await api("/api/connect",{userId:user.id,userName:user.first_name,targetId:connectId.value});
  tg.showAlert("Soâ€˜rov yuborildi");
}

// -------- share
function shareInvite(){
  const text=`Ulanish uchun botga /connect ${user.id} deb yuboring`;
  window.open("https://t.me/share/url?text="+encodeURIComponent(text),"_blank");
}

// -------- leave
async function leaveFamily(){
  await api("/api/unc",{userId:user.id});
  tg.showAlert("Chiqding");
  familyState();
}

// -------- family state
async function familyState(){
  const data=await api("/api/stats",{userId:user.id});
  const mine=data.filter(x=>x.name===user.first_name).length;
  if(data.length>mine){
    connect-block.classList.add("hidden");
    leave-block.classList.remove("hidden");
  } else {
    connect-block.classList.remove("hidden");
    leave-block.classList.add("hidden");
  }
}

// -------- stats
async function loadStats(){
  const data=await api("/api/stats",{userId:user.id});
  let t=0,m=0;
  const now=new Date();
  let html="";
  data.sort((a,b)=>b.id-a.id).forEach(x=>{
    const d=new Date(x.id);
    if(d.toDateString()===now.toDateString())t+=+x.amount;
    if(d.getMonth()===now.getMonth())m+=+x.amount;

    html+=`
    <div class="bg-black/30 p-3 rounded-xl flex justify-between items-center">
      <div>${x.cat} <span class="text-xs text-sky-400">(${x.name})</span></div>
      <div class="flex gap-3 items-center">
        <b>${x.amount}</b>
        <button onclick="del(${x.id})" class="text-red-400 text-xl">âœ–</button>
      </div>
    </div>`;
  });
  st-today.innerText=t;
  st-month.innerText=m;
  history.innerHTML=html;
}

// -------- delete
async function del(id){
  await api("/api/delete",{userId:user.id,id});
  tg.showAlert("Oâ€˜chirildi");
  loadStats();
}
</script>

</body>
</html>
