<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASik Family Hub</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans min-h-screen">

    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10">
        <h1 id="user-name" class="text-lg font-bold">Yuklanmoqda...</h1>
        <p class="text-xs opacity-80">ASik Family Hub Online v2.5</p>
    </header>

    <main class="p-4 space-y-6">
        
        <section class="bg-white p-4 rounded-xl shadow-sm">
            <h2 class="text-sm font-semibold text-gray-500 mb-3 uppercase">üí∞ Xarajat qo'shish</h2>
            <div class="space-y-3">
                <input type="number" id="amount" placeholder="Summa (masalan: 15000)" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="text" id="category" placeholder="Nima uchun? (masalan: Bozorlik)" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="addExpense()" id="btn-add"
                        class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:scale-95 transition-transform">
                    Saqlash
                </button>
            </div>
        </section>

        <section class="bg-white p-4 rounded-xl shadow-sm">
            <h2 class="text-sm font-semibold text-gray-500 mb-3 uppercase">‚úâÔ∏è Oilaga xabar</h2>
            <div class="flex space-x-2">
                <input type="text" id="family-msg" placeholder="Xabar matni..." 
                       class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                <button onclick="sendMessage()" 
                        class="bg-green-600 text-white px-4 rounded-lg active:scale-90">
                    Yuborish
                </button>
            </div>
        </section>

        <section class="bg-white p-4 rounded-xl shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-sm font-semibold text-gray-500 uppercase">üìä Oxirgi xarajatlar</h2>
                <button onclick="loadStats()" class="text-blue-600 text-xs font-bold">Yangilash</button>
            </div>
            <div id="stats-list" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-gray-400 text-center py-4">Ma'lumotlar yuklanmoqda...</p>
            </div>
        </section>

    </main>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // Ilovani to'liq ekranga yoyish
        
        // Worker manzilingizni shu yerga yozing
        const API_URL = "asik.windowsnoutbook.workers.dev";

        const user = tg.initDataUnsafe?.user || { id: "12345", first_name: "Mehmon" };
        document.getElementById('user-name').innerText = `Salom, ${user.first_name}!`;

        // 1. Xarajat qo'shish
        async function addExpense() {
            const amount = document.getElementById('amount').value;
            const cat = document.getElementById('category').value;
            const btn = document.getElementById('btn-add');

            if (!amount || !cat) return alert("Hamma maydonni to'ldiring!");

            btn.disabled = true;
            btn.innerText = "Yuborilmoqda...";

            try {
                const res = await fetch(`${API_URL}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        userName: user.first_name,
                        amount: amount,
                        cat: cat
                    })
                });

                if (res.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    document.getElementById('amount').value = '';
                    document.getElementById('category').value = '';
                    loadStats();
                }
            } catch (e) {
                alert("Xato yuz berdi!");
            } finally {
                btn.disabled = false;
                btn.innerText = "Saqlash";
            }
        }

        // 2. Oilaga xabar yuborish
        async function sendMessage() {
            const msgInput = document.getElementById('family-msg');
            const msg = msgInput.value;
            if (!msg) return;

            // Telegram Botga xabar yuborish buyrug'ini tushunadigan API
            // Worker kodingizda /api/send marshruti bo'lishi kerak yoki bot orqali yuboriladi
            tg.sendData(JSON.stringify({type: 'message', text: msg}));
            
            msgInput.value = '';
            tg.HapticFeedback.impactOccurred('medium');
            alert("Xabar bot orqali yuboriladi!");
        }

        // 3. Statistikani yuklash
        async function loadStats() {
            const listDiv = document.getElementById('stats-list');
            try {
                const res = await fetch(`${API_URL}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id })
                });
                const data = await res.json();

                listDiv.innerHTML = '';
                if (data.length === 0) {
                    listDiv.innerHTML = '<p class="text-center text-gray-400">Xarajatlar yo'q</p>';
                    return;
                }

                data.reverse().slice(0, 10).forEach(item => {
                    const date = new Date(item.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    listDiv.innerHTML += `
                        <div class="flex justify-between items-center p-2 border-b border-gray-50 text-sm">
                            <div>
                                <div class="font-bold">${item.cat}</div>
                                <div class="text-xs text-gray-400">${item.name} ‚Ä¢ ${date}</div>
                            </div>
                            <div class="font-mono font-bold text-blue-600">${Number(item.amount).toLocaleString()}</div>
                        </div>
                    `;
                });
            } catch (e) {
                listDiv.innerHTML = '<p class="text-red-400">Yuklashda xato!</p>';
            }
        }

        // Dastlabki yuklash
        loadStats();
    </script>
</body>
</html>
