<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Hub</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{
  background: var(--tg-theme-bg-color,#fff);
  color: var(--tg-theme-text-color,#000);
}
.btn-primary{
  background: var(--tg-theme-button-color,#3390ec);
  color: var(--tg-theme-button-text-color,#fff);
}
</style>
</head>

<body class="p-4 select-none">

<!-- ------------------ TABS ------------------ -->
<div class="space-y-4">

<div class="hidden" id="tab-add">
  <h1 class="text-2xl font-bold text-center mb-3">â• Xarajat qoâ€˜shish</h1>

  <label>Summa</label>
  <input id="amount" type="number" class="w-full p-3 rounded-xl border">

  <label class="mt-2 block">Nima?</label>
  <input id="cat" type="text" class="w-full p-3 rounded-xl border">

  <button onclick="addExpense()" class="btn-primary w-full mt-3 p-3 rounded-xl font-bold">
    Qoâ€˜shish
  </button>
</div>

<div class="hidden" id="tab-me">
  <h1 class="text-2xl font-bold text-center mb-3">ğŸ“‹ Shaxsiy xarajatlar</h1>
  <ul id="me-list" class="space-y-2 text-sm"></ul>
</div>

<div class="hidden" id="tab-family">
  <h1 class="text-2xl font-bold text-center mb-3">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Umumiy roâ€˜yxat</h1>
  <ul id="fam-list" class="space-y-2 text-sm"></ul>
</div>

<div class="hidden" id="tab-stats">
  <h1 class="text-2xl font-bold text-center mb-3">ğŸ“Š Statistika</h1>

  <div class="flex justify-between bg-gray-100 p-3 rounded-xl">
    <span>Bugun:</span><span id="stat-today">0</span>
  </div>

  <div class="flex justify-between bg-gray-100 p-3 rounded-xl">
    <span>Shu oy:</span><span id="stat-month">0</span>
  </div>

  <h3 class="mt-3 font-bold">Oxirgi xaridlar:</h3>
  <ul id="hist-list" class="space-y-2 text-sm"></ul>

  <button onclick="getExcel()" class="btn-primary w-full mt-3 p-3 rounded-xl">
    ğŸ§¾ Excel (CSV) olish
  </button>
</div>

<div class="hidden" id="tab-send">
  <h1 class="text-2xl font-bold text-center mb-3">âœ‰ï¸ Oilaga xabar</h1>

  <textarea id="send-msg" class="w-full p-3 rounded-xl border" rows="4"
    placeholder="Masalan: Bugun soat 7 da yigâ€˜ilish :)"></textarea>

  <button onclick="sendMessageFamily()" class="btn-primary w-full mt-3 p-3 rounded-xl">
    Yuborish
  </button>
</div>

<div class="hidden" id="tab-connect">
  <h1 class="text-2xl font-bold text-center mb-3">ğŸ”— Oila boshqaruvi</h1>

  <button onclick="openConnect()" class="btn-primary w-full p-3 rounded-xl mb-2">
    â• Oila ulash (/connect)
  </button>

  <button onclick="leaveFamily()" class="btn-primary w-full p-3 rounded-xl">
    ğŸšª Oiladan chiqish (/unc)
  </button>
</div>

</div>

<!-- ------------------ NAVIGATION ------------------ -->
<div class="fixed bottom-0 left-0 w-full border-t bg-white p-2 flex justify-around">
<button onclick="tab('add')">â•</button>
<button onclick="tab('me')">ğŸ“‹</button>
<button onclick="tab('family')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</button>
<button onclick="tab('stats')">ğŸ“Š</button>
<button onclick="tab('send')">âœ‰ï¸</button>
<button onclick="tab('connect')">âš™ï¸</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_URL = "https://asik.windowsnoutbook.workers.dev";
const BOT_USERNAME = "@ASikkeeper_bot";

const user = tg.initDataUnsafe.user || { id:"test", first_name:"Test" };

function tab(name){
  document.querySelectorAll("[id^='tab-']").forEach(b=>b.classList.add("hidden"));
  document.getElementById("tab-"+name).classList.remove("hidden");

  if(name==="me") loadMe();
  if(name==="family") loadFamily();
  if(name==="stats") loadStats();
}

// --------------- ADD EXPENSE ----------------
async function addExpense(){
  const a=document.getElementById("amount").value;
  const c=document.getElementById("cat").value;

  if(!a||!c){ tg.showAlert("Maydonlarni toâ€˜ldir!"); return; }

  await fetch(API_URL+"/api/add",{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({
      userId:user.id,
      userName:user.first_name,
      amount:a,
      cat:c
    })
  });

  document.getElementById("amount").value="";
  document.getElementById("cat").value="";
  tg.showAlert("âœ… Qoâ€˜shildi");
}

// --------------- LOAD ALL DATA ----------------
async function getAll(){
  const r=await fetch(API_URL+"/api/stats",{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({ userId:user.id })
  });
  return r.json();
}

// --------------- PERSONAL LIST ----------------
async function loadMe(){
  const data=await getAll();
  let html="";
  data.filter(x=>x.name===user.first_name).forEach(x=>{
    html+=`<li class="border-b pb-1">${x.cat} â€” <b>${x.amount}</b></li>`;
  });
  document.getElementById("me-list").innerHTML=html||"Boâ€˜sh";
}

// --------------- FAMILY LIST ----------------
async function loadFamily(){
  const data=await getAll();
  let html="";
  data.forEach(x=>{
    html+=`<li class="border-b pb-1">
      ${x.cat} â€” <b>${x.amount}</b>
      <span class="text-xs opacity-50">(${x.name})</span>
    </li>`;
  });
  document.getElementById("fam-list").innerHTML=html||"Boâ€˜sh";
}

// --------------- STATS ----------------
async function loadStats(){
  const data=await getAll();
  const now=new Date();

  let today=0, month=0, html="";

  data.sort((a,b)=>b.id-a.id);

  data.forEach(x=>{
    const d=new Date(x.id);
    if(d.toDateString()===now.toDateString()) today+=Number(x.amount);
    if(d.getMonth()===now.getMonth()) month+=Number(x.amount);

    html+=`<li class="border-b pb-1">
      ${x.cat} â€” <b>${x.amount}</b>
      <span class="text-xs opacity-50">(${x.name})</span>
    </li>`;
  });

  document.getElementById("stat-today").innerText=today.toLocaleString();
  document.getElementById("stat-month").innerText=month.toLocaleString();
  document.getElementById("hist-list").innerHTML=html;
}

// --------------- CSV VIA BOT ----------------
function getExcel(){
  window.open(`https://t.me/${BOT_USERNAME}?start=stats`,`_blank`);
}

// --------------- SEND FAMILY MESSAGE ----------------
function sendMessageFamily(){
  const msg=document.getElementById("send-msg").value;
  if(!msg){ tg.showAlert("Xabar yoz!"); return; }
  window.open(`https://t.me/${BOT_USERNAME}?start=send_${encodeURIComponent(msg)}`);
}

// --------------- CONNECT / LEAVE FAMILY ----------------
function openConnect(){
  tg.showAlert("Botda /connect buyrugâ€˜idan foydalaning");
  window.open(`https://t.me/${BOT_USERNAME}`);
}

function leaveFamily(){
  window.open(`https://t.me/${BOT_USERNAME}?start=unc`);
}
</script>
</body>
</html>
