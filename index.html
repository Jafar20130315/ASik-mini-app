<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ilova</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --bg:#0b1220; --card:#071226; --muted:#9aa6b2; --accent:#0ea5a4; --danger:#ef4444;
  }
  body{
    margin:0;
    font-family:Inter,system-ui;
    background:linear-gradient(180deg,#061026,#02101a);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
  }
  .app{ max-width:420px; margin:18px auto 96px; padding:16px; }
  .card{
    background:var(--card);
    border-radius:14px;
    padding:14px;
    box-shadow:0 18px 40px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .muted{ color:var(--muted); font-size:13px; }
  input,textarea{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.04);
    background:rgba(255,255,255,0.02);
    color:#e6eef6;
  }
  .row{ display:flex; gap:8px; align-items:center; }
  .btn{ cursor:pointer; border:0; padding:10px 12px; border-radius:10px; font-weight:700; }
  .btn-primary{ background:linear-gradient(90deg,var(--accent),#3b82f6); color:#041227; }
  .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }
  .btn-danger{ background:linear-gradient(90deg,#fb7185,#ef4444); color:white; }
  .nav{
    position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
    width:min(420px,calc(100% - 24px));
    background:rgba(2,6,23,0.6);
    padding:10px; border-radius:14px;
    display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    border:1px solid rgba(255,255,255,0.03);
  }
  .nav button{
    background:transparent; color:var(--muted);
    border:0; display:flex; flex-direction:column;
    align-items:center; gap:6px; font-weight:700;
  }
  .nav button.active{ color:var(--accent); }
  .list-item{
    display:flex; justify-content:space-between; align-items:center;
    gap:10px; padding:10px; border-radius:10px;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.02);
  }
  .icon{ width:20px; height:20px; display:inline-block; }
  .family-list{ display:flex; flex-direction:column; gap:8px; }
</style>
</head>

<body>
<div class="app">
<header>
  <div>
    <h1 style="margin:0;font-size:18px;font-weight:800">Family Hub</h1>
    <div class="muted" id="sub">Oilaviy hisob-kitob</div>
  </div>
  <div style="text-align:right">
    <div id="userName" style="font-weight:700">â€”</div>
    <div class="muted" id="userId" style="font-family:monospace;font-size:12px"></div>
  </div>
</header>

<!-- ADD -->
<section id="tab-add" class="card mb-4">
  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
    <div style="font-weight:800">Xarajat qoâ€˜shish</div>
    <div class="muted small">Tez va aniq</div>
  </div>

  <div class="row" style="margin-bottom:8px">
    <input id="amount" type="number" placeholder="Summa (12000)">
    <input id="cat" type="text" placeholder="Nima olindi? (Non, Taksi)">
  </div>

  <div style="display:flex;gap:8px">
    <button id="saveBtn" class="btn btn-primary" onclick="addExpense()">ğŸ’¾ Saqlash</button>
    <button class="btn btn-ghost" onclick="openTab('stats')">ğŸ“Š Koâ€˜rish</button>
  </div>
</section>

<!-- STATS -->
<section id="tab-stats" class="card mb-4 hidden">
  <div style="display:flex;justify-content:space-between;margin-bottom:12px">
    <div style="font-weight:800">Statistika</div>
    <div style="text-align:right">
      <div class="muted small">Bugun</div>
      <div id="stToday" style="font-weight:800">0</div>
    </div>
  </div>

  <div style="display:flex;justify-content:space-between;margin-bottom:12px">
    <div class="muted small">Bu oy</div>
    <div id="stMonth" style="font-weight:800">0</div>
  </div>

  <div id="history" style="display:flex;flex-direction:column;gap:8px"></div>

  <div style="margin-top:12px;font-weight:800">ğŸ“… Kalendar boâ€˜yicha</div>
  <div id="calendar" style="display:flex;flex-direction:column;gap:8px"></div>
</section>

<!-- SEND -->
<section id="tab-send" class="card mb-4 hidden">
  <div style="font-weight:800;margin-bottom:8px">Oilaga xabar</div>
  <textarea id="msg" rows="4" placeholder="Xabar matni..."></textarea>
  <div style="height:8px"></div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-primary" onclick="sendMessage()">ğŸ“¤ Yuborish</button>
    <button class="btn btn-ghost" onclick="openTab('family')">ğŸ‘¥ Oila</button>
  </div>
</section>

<!-- FAMILY -->
<section id="tab-family" class="card mb-4 hidden">
  <div style="display:flex;justify-content:space-between;margin-bottom:8px">
    <div style="font-weight:800">Oila</div>
    <div class="muted small">Boshliq va a'zolar</div>
  </div>

  <div id="familyInfo" class="family-list"></div>

  <div style="height:8px"></div>

  <div id="connectBlock">
    <input id="connectId" type="number" placeholder="Oila boshligâ€˜i ID">
    <div style="height:8px"></div>
    <button class="btn btn-primary" onclick="connectFamily()">ğŸ”— Ulanish soâ€˜rash</button>
    <div style="height:8px"></div>
    <button class="btn btn-ghost" onclick="shareInvite()">ğŸ“¤ Oilani ulash</button>
  </div>

  <div id="leaveBlock" class="hidden" style="margin-top:10px">
    <div class="muted" style="margin-bottom:8px">Siz hozir oiladasiz</div>
    <button class="btn btn-danger" onclick="confirmLeave()">ğŸšª Oiladan chiqish</button>
  </div>
</section>

<div style="height:84px"></div>
</div>

<!-- NAV -->
<nav class="nav">
  <button id="nav-add" class="active" onclick="openTab('add')">
    â•
    Qoâ€˜shish
  </button>
  <button id="nav-stats" onclick="openTab('stats')">ğŸ“Š Stat</button>
  <button id="nav-send" onclick="openTab('send')">âœ‰ï¸ Xabar</button>
  <button id="nav-family" onclick="openTab('family')">ğŸ‘¥ Oila</button>
</nav>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand?.();

const API_URL = "https://asik.windowsnoutbook.workers.dev"; // â¬…ï¸ o'zingnikiga almashtir

const user = tg?.initDataUnsafe?.user || { id:"test_user", first_name:"Test" };
document.getElementById("userName").innerText = user.first_name;
document.getElementById("userId").innerText = "ID: " + user.id;

// API helper
async function api(path, body){
  const r = await fetch(API_URL + path,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  return r.json();
}

// Tabs
function openTab(n){
  ["add","stats","send","family"].forEach(t=>{
    document.getElementById("tab-"+t).classList.toggle("hidden",t!==n);
    document.getElementById("nav-"+t)?.classList?.toggle("active",t===n);
  });
  if(n==="stats") loadStats();
  if(n==="family") refreshFamily();
}

// ADD EXPENSE
async function addExpense(){
  const amt=document.getElementById("amount").value.trim();
  const cat=document.getElementById("cat").value.trim()||"noma'lum";
  if(!amt) return alert("Summa kiriting");

  await api("/api/add",{userId:String(user.id),userName:user.first_name,amount:amt,cat});
  tg?.showAlert?.("âœ”ï¸ Saqlandi");

  document.getElementById("amount").value="";
  document.getElementById("cat").value="";
  loadStats();
}

// LOAD STATS + CALENDAR
async function loadStats(){
  const data=await api("/api/stats",{userId:String(user.id)});
  const now=new Date();
  let today=0, month=0;

  const history=document.getElementById("history");
  const calendar=document.getElementById("calendar");
  history.innerHTML=""; calendar.innerHTML="";

  data.sort((a,b)=>b.id-a.id);

  const byDate={};

  for(const x of data){
    const d=new Date(x.createdAt||x.id);
    const key=d.toISOString().split("T")[0];
    const amount=Number(x.amount)||0;

    if(d.toDateString()===now.toDateString()) today+=amount;
    if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()) month+=amount;

    if(!byDate[key]) byDate[key]=[];
    byDate[key].push(x);

    const item=document.createElement("div");
    item.className="list-item";
    item.innerHTML=`<div><div style="font-weight:700">${x.cat}</div><div class="muted small">${d.toLocaleString()}</div></div><div style="font-weight:800">${amount.toLocaleString()}</div>`;
    history.appendChild(item);
  }

  // calendar
  for(const day in byDate){
    const block=document.createElement("div");
    block.className="card";
    const d=new Date(day);
    let sum=0;
    byDate[day].forEach(x=>sum+=Number(x.amount)||0);

    let html=`<div style="font-weight:800;margin-bottom:6px">${d.toLocaleDateString()} â€” ${sum.toLocaleString()} so'm</div>`;
    for(const x of byDate[day]){
      html+=`<div class="list-item"><div>${x.cat}</div><div style="font-weight:700">${Number(x.amount).toLocaleString()}</div></div>`;
    }
    block.innerHTML=html;
    calendar.appendChild(block);
  }

  document.getElementById("stToday").innerText=today.toLocaleString();
  document.getElementById("stMonth").innerText=month.toLocaleString();
}

// SEND MESSAGE
async function sendMessage(){
  const text=document.getElementById("msg").value.trim();
  if(!text) return alert("Matn yozing");
  await api("/api/send",{userId:String(user.id),userName:user.first_name,text});
  document.getElementById("msg").value="";
}

// FAMILY
async function connectFamily(){
  const id=document.getElementById("connectId").value.trim();
  await api("/api/connect",{userId:String(user.id),userName:user.first_name,targetId:id});
}

function shareInvite(){
  const text=`Ulanish uchun botga /connect ${user.id} deb yuboring`;
  window.open("https://t.me/share/url?text="+encodeURIComponent(text));
}

async function refreshFamily(){
  const f=await api("/api/family",{userId:String(user.id)});
  const box=document.getElementById("familyInfo");
  box.innerHTML=`<div class="list-item"><b>Boshliq:</b> ${f.leader}</div>`;
  f.members?.forEach(m=>{
    const d=document.createElement("div");
    d.className="list-item";
    d.innerText="ğŸ‘¤ "+m;
    box.appendChild(d);
  });
}
</script>

</body>
</html>
