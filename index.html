<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ASik App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
  :root {
    --bg-dark: #0f0f11;
    --card-bg: rgba(30, 30, 32, 0.65);
    --card-border: rgba(255, 255, 255, 0.08);
    --primary-gradient: linear-gradient(135deg, #0A84FF 0%, #0056b3 100%);
    --danger-gradient: linear-gradient(135deg, #FF453A 0%, #b3261e 100%);
    --text-primary: #ffffff;
    --text-secondary: #9ca3af;
    --radius: 20px;
    --glow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  }

  body {
    background-color: var(--bg-dark);
    /* Subtle background gradient for depth */
    background-image: 
        radial-gradient(circle at 0% 0%, rgba(10, 132, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(10, 132, 255, 0.05) 0%, transparent 50%);
    background-attachment: fixed;
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    margin: 0;
    padding-bottom: 110px; /* Increased padding for floating nav */
    min-height: 100vh;
  }

  /* Fade in animation */
  .fade-in {
    animation: fadeIn 0.4s ease-out forwards;
    opacity: 0;
    transform: translateY(10px);
  }
  @keyframes fadeIn {
    to { opacity: 1; transform: translateY(0); }
  }

  .modern-input {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    font-size: 17px;
    color: white;
    width: 100%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    outline: none;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
  }
  .modern-input:focus {
    background: rgba(0, 0, 0, 0.5);
    border-color: #0A84FF;
    box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15);
  }
  .modern-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
  }

  .glass-card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--card-border);
    border-top: 1px solid rgba(255, 255, 255, 0.15); /* Top highlight */
    border-radius: var(--radius);
    padding: 22px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: fadeIn 0.5s ease-out forwards;
  }

  .btn-action {
    background: var(--primary-gradient);
    color: white;
    font-weight: 600;
    border-radius: 16px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    width: 100%;
    box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
    position: relative;
    overflow: hidden;
  }
  .btn-action::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(rgba(255,255,255,0.1), transparent);
    pointer-events: none;
  }
  .btn-action:active { transform: scale(0.96); opacity: 0.9; }
  
  .btn-danger { 
    background: var(--danger-gradient);
    box-shadow: 0 4px 15px rgba(255, 69, 58, 0.3);
  }
  .btn-ghost { 
    background: rgba(255, 255, 255, 0.05); 
    color: #0A84FF; 
    box-shadow: none;
    border: 1px solid rgba(10, 132, 255, 0.2);
  }

  /* Floating Navigation */
  .nav-bar {
    position: fixed;
    bottom: 24px;
    left: 20px;
    right: 20px;
    background: rgba(20, 20, 22, 0.85);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border-radius: 28px;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    box-shadow: 0 15px 40px rgba(0,0,0,0.6);
  }

  .nav-item {
    color: #6b7280;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 16px;
    background: transparent;
    border: none;
    transition: all 0.3s ease;
    min-width: 64px;
    position: relative;
  }
  .nav-item i { 
    font-size: 24px; 
    margin-bottom: 2px; 
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .nav-item.active { 
    color: #ffffff; 
  }
  /* Glowing background for active item */
  .nav-item.active::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, rgba(10, 132, 255, 0.2) 0%, transparent 70%);
    border-radius: 16px;
    z-index: -1;
  }
  .nav-item.active i {
    transform: translateY(-2px);
    color: #0A84FF;
    text-shadow: 0 0 12px rgba(10, 132, 255, 0.6);
  }

  .profile-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #2c2c2e;
    overflow: hidden;
    border: 2px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: transform 0.2s;
  }
  .profile-avatar:active { transform: scale(0.9); }
  .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .list-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    transition: background 0.2s;
  }
  .list-row:last-child { border-bottom: none; }
  
  .hidden { display: none !important; }

  h1 { 
    font-size: 32px; 
    font-weight: 800; 
    letter-spacing: -1px; 
    margin: 0; 
    background: linear-gradient(to right, #fff, #cbd5e1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  h2 { font-size: 20px; font-weight: 700; margin-bottom: 15px; letter-spacing: -0.5px; }
  
  .subtitle { 
    font-size: 12px; 
    color: var(--text-secondary); 
    font-weight: 600; 
    text-transform: uppercase; 
    letter-spacing: 1.5px; 
    margin-bottom: 12px; 
    display: block;
    opacity: 0.8;
  }

  /* LOCK overlay */
  .lock-wrap {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .lock-card {
    width: 100%;
    max-width: 420px;
    background: #1c1c1e;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px;
    padding: 30px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    text-align: center;
  }
  .lock-title {
    font-weight: 800;
    font-size: 20px;
    margin: 10px 0 8px 0;
  }
  .lock-sub {
    color: var(--text-secondary);
    font-size: 15px;
    margin: 0 0 20px 0;
    line-height: 1.5;
  }

  /* Telegram-only overlay */
  .tg-only {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .tg-only-card {
    width: 100%;
    max-width: 420px;
    background: #1c1c1e;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px;
    padding: 30px;
    text-align: center;
  }

  /* --- Skeleton (Shimmer) --- */
  .skel {
    position: relative;
    overflow: hidden;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
  }
  .skel::after {
    content: "";
    position: absolute;
    top: 0;
    left: -160px;
    height: 100%;
    width: 160px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer {
    0% { transform: translateX(0); }
    100% { transform: translateX(400px); }
  }
  .skel-line { height: 12px; border-radius: 6px; }
  .skel-line.sm { height: 10px; }
  .skel-line.lg { height: 20px; }
  .skel-circle { width: 40px; height: 40px; border-radius: 50%; }

  .skel-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .skel-row:last-child { border-bottom: none; }

  /* Amount specific style */
  #amount {
    font-feature-settings: "tnum";
    letter-spacing: -1px;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.03);
    text-align: center;
    padding: 20px;
    font-size: 32px;
  }
  #amount:focus {
    background: rgba(0,0,0,0.4);
    border-color: #0A84FF;
  }

  /* Icon circle styles */
  .icon-circle {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(10, 132, 255, 0.15);
    display: flex; align-items: center; justify-content: center;
    color: #0A84FF;
    flex-shrink: 0;
  }
</style>
</head>
<body>

<div class="p-5 max-w-md mx-auto fade-in">

  <!-- HEADER -->
  <header class="flex justify-between items-center mb-8 pt-2">
    <div>
      <div class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-1">Hamyon</div>
      <h1 id="pageTitle">Xarajatlar</h1>
    </div>
    <div class="profile-avatar" onclick="openTab('family')">
      <!-- Fixed onError to prevent null reference -->
      <img id="userAvatar" src="" alt="User" onerror="this.style.display='none'; if(this.parentElement) this.parentElement.innerHTML='<i class=\'ph-bold ph-user text-white text-xl\'></i>'">
    </div>
  </header>

  <!-- ADD EXPENSE -->
  <section id="tab-add" class="fade-in">
    <div class="glass-card">
      <span class="subtitle" id="subNew">Yangi qo'shish</span>
      <div class="flex flex-col gap-4">
        <input id="amount" type="number" class="modern-input font-bold" placeholder="0">
        <input id="cat" type="text" class="modern-input" placeholder="Nima olindi? (Non, Go'sht)">
        <button onclick="addExpense()" class="btn-action mt-2">
          <i class="ph-bold ph-plus leading-none text-lg"></i> <span id="btnAddText">Qo'shish</span>
        </button>
      </div>
    </div>

    <div class="glass-card">
      <span class="subtitle" id="subToday">Bugungi holat</span>
      <div class="flex justify-between items-end">
        <div>
          <div class="text-gray-400 text-sm mb-1" id="lblTodaySpent">Bugun sarflandi</div>
          <div id="quickStatsToday" class="text-3xl font-bold text-white tracking-tight">
            <!-- skeleton placeholder -->
          </div>
        </div>
        <button onclick="openTab('stats')" class="text-blue-400 font-semibold text-sm bg-blue-500/10 px-3 py-1.5 rounded-lg border border-blue-500/20 active:scale-95 transition-transform" id="btnFull">
          To'liq ‚Üí
        </button>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="tab-stats" class="hidden fade-in">
    <div class="glass-card">
      <span class="subtitle" id="subReport">Umumiy hisobot</span>
      <div class="flex justify-between items-center mb-6 p-2 bg-white/5 rounded-xl border border-white/5">
        <span class="text-gray-400 text-sm ml-2" id="lblMonthTotal">Jami (Oy):</span>
        <span id="stMonth" class="text-2xl font-bold text-blue-400 mr-2">
          <!-- skeleton -->
        </span>
      </div>
      <div id="history" class="flex flex-col gap-1"></div>
    </div>

    <h2 class="mt-8 px-2 text-gray-300 flex items-center gap-2" id="hHistory">
        <i class="ph-fill ph-clock-counter-clockwise text-gray-500"></i> Tarix
    </h2>
    <div id="calendar" class="flex flex-col gap-3"></div>
  </section>

  <!-- FAMILY SETTINGS -->
  <section id="tab-family" class="hidden fade-in">
    <div class="glass-card text-center relative overflow-hidden">
      <!-- Decor background -->
      <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-blue-500/20 to-transparent pointer-events-none"></div>
      
      <div class="relative z-10">
        <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-blue-600 to-indigo-500 mx-auto flex items-center justify-center mb-4 text-4xl text-white shadow-lg shadow-blue-500/30">
            <i class="ph-bold ph-house-line leading-none"></i>
        </div>
        <h2 id="familyName" class="m-0 text-2xl">Mening Oilam</h2>
        <div class="inline-block bg-white/10 rounded-full px-3 py-1 text-xs text-gray-300 mt-2 font-mono border border-white/10" id="familyIdDisplay">ID: ...</div>
      </div>
    </div>

    <div class="mb-3 px-2 flex justify-between items-end">
      <span class="subtitle mb-0" id="subMembers">Ishtirokchilar</span>
    </div>

    <div class="glass-card p-0 overflow-hidden">
      <div id="familyList" class="divide-y divide-white/5"></div>
    </div>

    <div class="glass-card">
      <span class="subtitle" id="subControl">Boshqaruv</span>
      <div class="flex flex-col gap-3">
        <div id="connectBlock">
          <p class="text-sm text-gray-400 mb-2" id="lblConnectHelp">Boshqa oilaga qo'shilish uchun ID kiriting:</p>
          <div class="flex gap-2">
            <input id="connectId" type="number" class="modern-input py-3" placeholder="Oila ID">
            <button class="btn-action w-auto px-5" onclick="connectFamily()">
              <i class="ph-bold ph-arrow-right leading-none"></i>
            </button>
          </div>
        </div>

        <button class="btn-action btn-ghost w-full justify-center mt-2" onclick="shareInvite()">
          <i class="ph-bold ph-share-network leading-none"></i> <span id="btnInvite">Taklif havolasi</span>
        </button>

        <button id="leaveBtn" class="btn-action btn-danger w-full justify-center hidden mt-2" onclick="confirmLeave()">
          <i class="ph-bold ph-sign-out leading-none"></i> <span id="btnLeave">Oiladan chiqish</span>
        </button>
      </div>
    </div>
  </section>

  <!-- SEND MESSAGE -->
  <section id="tab-send" class="hidden fade-in">
    <div class="glass-card">
      <span class="subtitle" id="subSend">Xabar yuborish</span>
      <textarea id="msg" rows="5" class="modern-input mb-4 resize-none" placeholder="Oila a'zolariga xabar qoldiring..."></textarea>
      <button class="btn-action" onclick="sendMessage()">
        <i class="ph-bold ph-paper-plane-right leading-none"></i> <span id="btnSendText">Yuborish</span>
      </button>
    </div>
  </section>

</div>

<!-- NAVIGATION -->
<nav class="nav-bar">
  <button id="nav-add" class="nav-item active" onclick="openTab('add')">
    <i class="ph-fill ph-plus-circle"></i>
    <span id="navAdd">Qo'shish</span>
  </button>
  <button id="nav-stats" class="nav-item" onclick="openTab('stats')">
    <i class="ph-fill ph-chart-bar"></i>
    <span id="navStats">Hisobot</span>
  </button>
  <button id="nav-send" class="nav-item" onclick="openTab('send')">
    <i class="ph-fill ph-chat-circle-text"></i>
    <span id="navSend">Xabar</span>
  </button>
  <button id="nav-family" class="nav-item" onclick="openTab('family')">
    <i class="ph-fill ph-users-three"></i>
    <span id="navFamily">Oila</span>
  </button>
</nav>

<script>
/** ---------------- Telegram-only guard ---------------- */
function blockNonTelegram() {
  const wrap = document.createElement("div");
  wrap.className = "tg-only";
  wrap.innerHTML = `
    <div class="tg-only-card">
      <div class="flex flex-col items-center gap-4 mb-3">
        <div class="w-16 h-16 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-3xl shadow-[0_0_20px_rgba(59,130,246,0.3)]">
          <i class="ph-bold ph-telegram-logo"></i>
        </div>
        <div>
          <div class="lock-title">Faqat Telegram orqali</div>
          <div class="text-sm text-gray-500">Ushbu sahifa faqat Telegram Mini App ichida ishlaydi.</div>
        </div>
      </div>
      <p class="lock-sub mt-2">Botdan ‚ÄúüìÜ Oylik xarajatlar‚Äù tugmasi orqali och.</p>
    </div>
  `;
  document.body.appendChild(wrap);
}

const tg = window.Telegram?.WebApp;
const isTelegram = !!(tg && tg.initData && tg.initData.length > 0 && tg.initDataUnsafe?.user?.id);
if (!isTelegram) {
  blockNonTelegram();
}

/** ---------------- CONFIG / INIT ---------------- */
tg?.expand?.();
if (tg) {
  tg.setHeaderColor('#0f0f11'); // Matches body bg
  tg.setBackgroundColor('#0f0f11');
}

// Worker URL
const API_URL = "https://asik.windowsnoutbook.workers.dev"; // <-- CHANGE IF NEEDED

// Bot url (REPLACE!)
const BOT_URL = "https://t.me/ASikkeeper_bot";

// Telegram user (if Telegram) or mock
const user = isTelegram
  ? (tg.initDataUnsafe.user)
  : { id: "", first_name: "Guest", photo_url: "" };

// Avatar
const avatarEl = document.getElementById("userAvatar");
if (user.photo_url) avatarEl.src = user.photo_url;
else {
  avatarEl.style.display = "none";
  if(avatarEl.parentElement) {
    avatarEl.parentElement.innerHTML = '<i class="ph-bold ph-user text-white text-xl"></i>';
  }
}

let currentFamilyData = null;
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

/** ---------------- i18n (Mini App) ---------------- */
let LANG = "uz";
const UI = {
  uz: {
    title_add: "Xarajatlar",
    title_stats: "Hisobot",
    title_send: "Xat yozish",
    title_family: "Oila Sozlamalari",
    nav_add: "Qo'shish",
    nav_stats: "Hisobot",
    nav_send: "Xabar",
    nav_family: "Oila",
    sub_new: "Yangi qo'shish",
    sub_today: "Bugungi holat",
    lbl_today_spent: "Bugun sarflandi",
    btn_full: "To'liq ‚Üí",
    sub_report: "Umumiy hisobot",
    lbl_month_total: "Jami (Oy):",
    h_history: "Tarix",
    sub_members: "Ishtirokchilar",
    sub_control: "Boshqaruv",
    lbl_connect_help: "Boshqa oilaga qo'shilish uchun ID kiriting:",
    btn_invite: "Taklif havolasi",
    btn_leave: "Oiladan chiqish",
    sub_send: "Xabar yuborish",
    btn_send: "Yuborish",
    btn_add: "Qo'shish",
    ph_amount: "0 so'm",
    ph_cat: "Nima olindi? (Non, Go'sht)",
    ph_msg: "Oila a'zolariga xabar qoldiring...",
    empty_no_cost: "Hozircha xarajat yo'q",
    empty_no_members: "Boshqa ishtirokchilar yo'q",
  },
  ru: {
    title_add: "–†–∞—Å—Ö–æ–¥—ã",
    title_stats: "–û—Ç—á—ë—Ç",
    title_send: "–°–æ–æ–±—â–µ–Ω–∏–µ",
    title_family: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–º—å–∏",
    nav_add: "–î–æ–±–∞–≤–∏—Ç—å",
    nav_stats: "–û—Ç—á—ë—Ç",
    nav_send: "–°–æ–æ–±—â–µ–Ω–∏–µ",
    nav_family: "–°–µ–º—å—è",
    sub_new: "–î–æ–±–∞–≤–∏—Ç—å",
    sub_today: "–°–µ–≥–æ–¥–Ω—è",
    lbl_today_spent: "–ü–æ—Ç—Ä–∞—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è",
    btn_full: "–ü–æ–ª–Ω—ã–π ‚Üí",
    sub_report: "–û–±—â–∏–π –æ—Ç—á—ë—Ç",
    lbl_month_total: "–ò—Ç–æ–≥–æ (–º–µ—Å—è—Ü):",
    h_history: "–ò—Å—Ç–æ—Ä–∏—è",
    sub_members: "–£—á–∞—Å—Ç–Ω–∏–∫–∏",
    sub_control: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
    lbl_connect_help: "–ß—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ–º—å–µ, –≤–≤–µ–¥–∏ ID:",
    btn_invite: "–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ",
    btn_leave: "–í—ã–π—Ç–∏ –∏–∑ —Å–µ–º—å–∏",
    sub_send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ",
    btn_send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
    btn_add: "–î–æ–±–∞–≤–∏—Ç—å",
    ph_amount: "0 —Å—É–º",
    ph_cat: "–ß—Ç–æ –∫—É–ø–∏–ª–∏? (–•–ª–µ–±, –ú—è—Å–æ)",
    ph_msg: "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–µ–º—å–µ...",
    empty_no_cost: "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤",
    empty_no_members: "–î—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç",
  },
  en: {
    title_add: "Expenses",
    title_stats: "Report",
    title_send: "Message",
    title_family: "Family Settings",
    nav_add: "Add",
    nav_stats: "Report",
    nav_send: "Message",
    nav_family: "Family",
    sub_new: "Add new",
    sub_today: "Today",
    lbl_today_spent: "Spent today",
    btn_full: "Full ‚Üí",
    sub_report: "Summary report",
    lbl_month_total: "Total (month):",
    h_history: "History",
    sub_members: "Members",
    sub_control: "Controls",
    lbl_connect_help: "Enter family ID to join:",
    btn_invite: "Invite link",
    btn_leave: "Leave family",
    sub_send: "Send message",
    btn_send: "Send",
    btn_add: "Add",
    ph_amount: "0",
    ph_cat: "What did you buy?",
    ph_msg: "Leave a message to family...",
    empty_no_cost: "No expenses yet",
    empty_no_members: "No other members",
  },
  kk: {
    title_add: "–®—ã“ì—ã–Ω–¥–∞—Ä",
    title_stats: "–ï—Å–µ–ø",
    title_send: "–•–∞–±–∞—Ä",
    title_family: "–û—Ç–±–∞—Å—ã –±–∞–ø—Ç–∞—É—ã",
    nav_add: "“ö–æ—Å—É",
    nav_stats: "–ï—Å–µ–ø",
    nav_send: "–•–∞–±–∞—Ä",
    nav_family: "–û—Ç–±–∞—Å—ã",
    sub_new: "–ñ–∞“£–∞ “õ–æ—Å—É",
    sub_today: "–ë“Ø–≥—ñ–Ω",
    lbl_today_spent: "–ë“Ø–≥—ñ–Ω –∂“±–º—Å–∞–ª–¥—ã",
    btn_full: "–¢–æ–ª—ã“õ ‚Üí",
    sub_report: "–ñ–∞–ª–ø—ã –µ—Å–µ–ø",
    lbl_month_total: "–ë–∞—Ä–ª—ã“ì—ã (–∞–π):",
    h_history: "–¢–∞—Ä–∏—Ö",
    sub_members: "“ö–∞—Ç—ã—Å—É—à—ã–ª–∞—Ä",
    sub_control: "–ë–∞—Å“õ–∞—Ä—É",
    lbl_connect_help: "–û—Ç–±–∞—Å—ã“ì–∞ “õ–æ—Å—ã–ª—É “Ø—à—ñ–Ω ID –µ–Ω–≥—ñ–∑:",
    btn_invite: "–®–∞“õ—ã—Ä—É —Å—ñ–ª—Ç–µ–º–µ—Å—ñ",
    btn_leave: "–û—Ç–±–∞—Å—ã–Ω–∞–Ω —à—ã“ì—É",
    sub_send: "–•–∞–±–∞—Ä –∂—ñ–±–µ—Ä—É",
    btn_send: "–ñ—ñ–±–µ—Ä—É",
    btn_add: "“ö–æ—Å—É",
    ph_amount: "0",
    ph_cat: "–ù–µ –∞–ª—ã–Ω–¥—ã?",
    ph_msg: "–û—Ç–±–∞—Å—ã“ì–∞ —Ö–∞–±–∞—Ä “õ–∞–ª–¥—ã—Ä...",
    empty_no_cost: "”ò–∑—ñ—Ä–≥–µ —à—ã“ì—ã–Ω –∂–æ“õ",
    empty_no_members: "–ë–∞—Å“õ–∞ “õ–∞—Ç—ã—Å—É—à—ã–ª–∞—Ä –∂–æ“õ",
  },
  ky: {
    title_add: "–ß—ã–≥—ã–º–¥–∞—Ä",
    title_stats: "–û—Ç—á–µ—Ç",
    title_send: "–ö–∞–±–∞—Ä",
    title_family: "“Æ–π-–±“Ø–ª”© –∂”©–Ω–¥”©”©",
    nav_add: "–ö–æ—à—É—É",
    nav_stats: "–û—Ç—á–µ—Ç",
    nav_send: "–ö–∞–±–∞—Ä",
    nav_family: "“Æ–π-–±“Ø–ª”©",
    sub_new: "–ñ–∞“£—ã –∫–æ—à—É—É",
    sub_today: "–ë“Ø–≥“Ø–Ω",
    lbl_today_spent: "–ë“Ø–≥“Ø–Ω —Å–∞—Ä–ø—Ç–∞–ª–¥—ã",
    btn_full: "–¢–æ–ª—É–∫ ‚Üí",
    sub_report: "–ñ–∞–ª–ø—ã –æ—Ç—á–µ—Ç",
    lbl_month_total: "–ñ–∞–ª–ø—ã (–∞–π):",
    h_history: "–¢–∞—Ä—ã—Ö",
    sub_members: "–ö–∞—Ç—ã—à—É—É—á—É–ª–∞—Ä",
    sub_control: "–ë–∞—à–∫–∞—Ä—É—É",
    lbl_connect_help: "“Æ–π-–±“Ø–ª”©–≥”© –∫–æ—à—É–ª—É—É “Ø—á“Ø–Ω ID –∫–∏—Ä–≥–∏–∑:",
    btn_invite: "–ß–∞–∫—ã—Ä—É—É —à–∏–ª—Ç–µ–º–µ—Å–∏",
    btn_leave: "“Æ–π-–±“Ø–ª”©–¥”©–Ω —á—ã–≥—É—É",
    sub_send: "–ö–∞–±–∞—Ä –∂–∏–±–µ—Ä“Ø“Ø",
    btn_send: "–ñ–∏–±–µ—Ä“Ø“Ø",
    btn_add: "–ö–æ—à—É—É",
    ph_amount: "0",
    ph_cat: "–≠–º–Ω–µ –∞–ª—ã–Ω–¥—ã?",
    ph_msg: "“Æ–π-–±“Ø–ª”©–≥”© –∫–∞–±–∞—Ä –∫–∞–ª—Ç—ã—Ä...",
    empty_no_cost: "–ê–∑—ã—Ä—ã–Ω—á–∞ —á—ã–≥—ã–º –∂–æ–∫",
    empty_no_members: "–ë–∞—à–∫–∞ –∫–∞—Ç—ã—à—É—É—á—É –∂–æ–∫",
  },
};

function applyLang(l) {
  LANG = UI[l] ? l : "uz";
  const S = UI[LANG];

  document.getElementById("navAdd").innerText = S.nav_add;
  document.getElementById("navStats").innerText = S.nav_stats;
  document.getElementById("navSend").innerText = S.nav_send;
  document.getElementById("navFamily").innerText = S.nav_family;

  document.getElementById("subNew").innerText = S.sub_new;
  document.getElementById("subToday").innerText = S.sub_today;
  document.getElementById("lblTodaySpent").innerText = S.lbl_today_spent;
  document.getElementById("btnFull").innerText = S.btn_full;

  document.getElementById("subReport").innerText = S.sub_report;
  document.getElementById("lblMonthTotal").innerText = S.lbl_month_total;
  document.getElementById("hHistory").innerText = S.h_history;

  document.getElementById("subMembers").innerText = S.sub_members;
  document.getElementById("subControl").innerText = S.sub_control;
  document.getElementById("lblConnectHelp").innerText = S.lbl_connect_help;
  document.getElementById("btnInvite").innerText = S.btn_invite;
  document.getElementById("btnLeave").innerText = S.btn_leave;

  document.getElementById("subSend").innerText = S.sub_send;
  document.getElementById("btnSendText").innerText = S.btn_send;
  document.getElementById("btnAddText").innerText = S.btn_add;

  document.getElementById("amount").placeholder = S.ph_amount;
  document.getElementById("cat").placeholder = S.ph_cat;
  document.getElementById("msg").placeholder = S.ph_msg;

  // title (current tab)
  openTab(currentTab, { silent: true });
}

/** ---------------- UI: LOCK (not registered) ---------------- */
let locked = false;
function showNotRegistered(msg) {
  if (locked) return;
  locked = true;

  // ONLY this phrase (no extra)
  const text = msg || "Botga qaytadan /start yubor";
  const wrap = document.createElement("div");
  wrap.className = "lock-wrap";
  wrap.innerHTML = `
    <div class="lock-card">
      <div class="flex flex-col items-center gap-4 mb-3">
        <div class="w-16 h-16 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-3xl shadow-[0_0_20px_rgba(239,68,68,0.3)]">
          <i class="ph-bold ph-warning-circle leading-none"></i>
        </div>
        <div>
          <div class="lock-title">Kirish mumkin emas</div>
          <div class="text-xs text-gray-400">UserID: ${escapeHtml(String(user.id || ""))}</div>
        </div>
      </div>

      <p class="lock-sub">${escapeHtml(text)}</p>

      <button class="btn-action" id="openBotBtn">
        <i class="ph-bold ph-telegram-logo leading-none"></i> Botni ochish
      </button>
    </div>
  `;
  document.body.appendChild(wrap);

  document.getElementById("openBotBtn").onclick = () => {
    if (tg?.openTelegramLink) tg.openTelegramLink(BOT_URL);
    else window.open(BOT_URL, "_blank");
  };

  tg?.showAlert?.(text);
}

/** ---------------- SKELETON RENDERERS ---------------- */
function skelLine(w, cls="") {
  return `<div class="skel skel-line ${cls}" style="width:${w}"></div>`;
}
function skelCircle() {
  return `<div class="skel skel-circle"></div>`;
}
function renderQuickStatsSkeleton() {
  document.getElementById("quickStatsToday").innerHTML =
    `<div class="skel skel-line lg" style="width:140px"></div>`;
}
function renderMonthSkeleton() {
  document.getElementById("stMonth").innerHTML =
    `<div class="skel skel-line lg" style="width:120px"></div>`;
}
function renderHistorySkeleton() {
  const history = document.getElementById("history");
  history.innerHTML = `
    ${[1,2,3,4,5].map(()=>`
      <div class="skel-row">
        ${skelCircle()}
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
          ${skelLine("70%")}
          ${skelLine("45%","sm")}
        </div>
        ${skelLine("70px")}
      </div>
    `).join("")}
  `;
}
function renderCalendarSkeleton() {
  const calendar = document.getElementById("calendar");
  calendar.innerHTML = `
    ${[1,2,3].map(()=>`
      <div class="glass-card !p-4">
        <div class="flex justify-between items-center mb-3 pb-2 border-b muted-divider">
          ${skelLine("120px")}
          ${skelLine("80px")}
        </div>
        <div class="flex flex-col gap-2">
          ${skelLine("70%","sm")}
          ${skelLine("62%","sm")}
          ${skelLine("50%","sm")}
        </div>
      </div>
    `).join("")}
  `;
}
function renderFamilySkeleton() {
  const listEl = document.getElementById("familyList");
  listEl.innerHTML = `
    <div class="p-4">
      <div class="flex items-center gap-3">
        ${skelCircle()}
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
          ${skelLine("60%")}
          ${skelLine("35%","sm")}
        </div>
        ${skelLine("40px")}
      </div>
    </div>
    ${[1,2,3].map(()=>`
      <div class="p-4">
        <div class="flex items-center gap-3">
          ${skelCircle()}
          <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
            ${skelLine("50%")}
            ${skelLine("30%","sm")}
          </div>
          ${skelLine("32px")}
        </div>
      </div>
    `).join("")}
  `;
}

/** ---------------- STABLE API ---------------- */
async function api(path, body, { timeoutMs = 12000, retries = 1 } = {}) {
  const btns = document.querySelectorAll("button");
  btns.forEach(b => b.style.opacity = "0.7");

  try {
    let lastErr = null;

    for (let attempt = 0; attempt <= retries; attempt++) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const r = await fetch(API_URL + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
          signal: controller.signal
        });

        const text = await r.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; }
        catch { data = { ok:false, error:"non_json", message:"Server noto'g'ri javob berdi", raw:text }; }

        clearTimeout(timer);

        if (!r.ok || (data && data.ok === false)) {
          const msg = data?.message || data?.error || `HTTP ${r.status}`;

          if (data?.error === "not_registered") {
            showNotRegistered(msg);
            return null;
          }
          if (data?.error === "target_not_found") {
            tg?.showAlert?.("Xatolik: " + (data?.message || "Bunday foydalanuvchi botda mavjud emas"));
            return null;
          }

          tg?.showAlert?.("Xatolik: " + msg);
          return null;
        }

        return data;
      } catch (e) {
        clearTimeout(timer);
        lastErr = e;
        if (attempt < retries) { await sleep(350 * (attempt + 1)); continue; }
        const msg = e?.name === "AbortError" ? "Timeout. Worker javob bermadi." : (e.message || "Unknown error");
        tg?.showAlert?.("Xatolik: " + msg);
        return null;
      }
    }

    throw lastErr;
  } finally {
    btns.forEach(b => b.style.opacity = "1");
  }
}

/** ---------------- LANG LOAD (from Worker) ---------------- */
async function loadLangFromServer() {
  if (!isTelegram) return;

  const res = await api("/api/lang", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || ""
  });

  if (res?.ok && res.lang) {
    applyLang(res.lang);
  } else {
    applyLang("uz");
  }
}

/** ---------------- NAVIGATION ---------------- */
let currentTab = "add";

function openTab(n, { silent = false } = {}){
  currentTab = n;

  ["add","stats","send","family"].forEach(t=>{
    document.getElementById("tab-"+t).classList.toggle("hidden",t!==n);
    document.getElementById("nav-"+t)?.classList?.toggle("active",t===n);
  });

  const S = UI[LANG] || UI.uz;
  const titles = {
    add: S.title_add,
    stats: S.title_stats,
    send: S.title_send,
    family: S.title_family
  };
  document.getElementById("pageTitle").innerText = titles[n] || "ASik";

  if (!silent) {
    if(n==="stats") loadStats();
    if(n==="family") refreshFamily();
    if(n==="add") loadQuickStats();

    window.scrollTo({top: 0, behavior: "smooth"});
  }
}

/** ---------------- ADD ---------------- */
async function addExpense(){
  const amt=document.getElementById("amount").value.trim();
  const cat=document.getElementById("cat").value.trim()||"Boshqa";
  if(!amt) return tg?.showAlert?.("Summani kiriting!");

  const res = await api("/api/add",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    amount:amt,
    cat
  });

  if(!res?.ok) return;

  tg?.HapticFeedback?.notificationOccurred?.("success");
  tg?.showAlert?.("‚úÖ Saqlandi");

  document.getElementById("amount").value="";
  document.getElementById("cat").value="";
  loadQuickStats();
}

async function loadQuickStats() {
  renderQuickStatsSkeleton();

  const data = await api("/api/stats",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });

  if(!Array.isArray(data)) return;

  const now = new Date();
  let today = 0;
  for (const x of data) {
    const ts = Number(x.createdAt || x.id);
    if (!ts) continue;
    const d = new Date(ts);
    if(d.toDateString() === now.toDateString()) today += (Number(x.amount)||0);
  }
  document.getElementById("quickStatsToday").innerText = today.toLocaleString() + " so'm";
}

/** ---------------- STATS ---------------- */
async function loadStats(){
  renderMonthSkeleton();
  renderHistorySkeleton();
  renderCalendarSkeleton();

  const data = await api("/api/stats",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });

  const history = document.getElementById("history");
  const calendar = document.getElementById("calendar");
  history.innerHTML = ""; calendar.innerHTML = "";

  const S = UI[LANG] || UI.uz;

  if(!Array.isArray(data) || !data.length) {
    history.innerHTML = `<div class='text-center text-gray-500 py-4'>${escapeHtml(S.empty_no_cost)}</div>`;
    document.getElementById("stMonth").innerText = "0 so'm";
    return;
  }

  const now = new Date();
  let month = 0;

  data.sort((a,b)=>Number(b.id)-Number(a.id));
  const byDate={};

  data.slice(0, 5).forEach(x => {
    const d = new Date(Number(x.createdAt || x.id));
    const div = document.createElement("div");
    div.className = "list-row";
    // Modified style for better icons
    div.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="icon-circle">
          <i class="ph-bold ph-shopping-bag leading-none text-lg"></i>
        </div>
        <div>
          <div class="font-semibold text-sm text-gray-100">${escapeHtml(x.cat || "noma'lum")}</div>
          <div class="text-xs text-gray-500">${escapeHtml(x.name || "User")} ‚Ä¢ ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</div>
        </div>
      </div>
      <div class="font-bold text-white text-base">${Number(x.amount||0).toLocaleString()}</div>
    `;
    history.appendChild(div);
  });

  for(const x of data){
    const d=new Date(Number(x.createdAt||x.id));
    const key=d.toISOString().split("T")[0];
    const amount=Number(x.amount)||0;

    if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()) month+=amount;

    if(!byDate[key]) byDate[key]=[];
    byDate[key].push(x);
  }

  const days = Object.keys(byDate).sort((a,b)=>a<b?1:-1);
  for(const day of days){
    const block=document.createElement("div");
    block.className="glass-card !p-0 overflow-hidden"; // Tighter styling for list

    const d=new Date(day+"T00:00:00");
    let sum=0;
    byDate[day].forEach(x=>sum+=Number(x.amount)||0);

    let html=`<div class="flex justify-between items-center p-4 bg-white/5 border-b border-white/5">
      <span class="font-bold text-gray-200">${d.toLocaleDateString()}</span>
      <span class="text-blue-400 font-bold bg-blue-500/10 px-2 py-0.5 rounded">${sum.toLocaleString()}</span>
    </div>
    <div class="p-4">`;

    for(const x of byDate[day]){
      html+=`<div class="flex justify-between text-sm mb-3 last:mb-0 items-center">
        <div class="flex flex-col">
            <span class="text-gray-300 font-medium">${escapeHtml(x.cat || "noma'lum")}</span>
            <span class="text-xs text-gray-500">${escapeHtml(x.name || "")}</span>
        </div>
        <span class="font-mono text-gray-200">${Number(x.amount||0).toLocaleString()}</span>
      </div>`;
    }
    html += `</div>`;
    block.innerHTML=html;
    calendar.appendChild(block);
  }

  document.getElementById("stMonth").innerText = month.toLocaleString() + " so'm";
}

/** ---------------- FAMILY ---------------- */
async function refreshFamily(){
  renderFamilySkeleton();

  const f = await api("/api/family",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });
  if (!f) return;

  currentFamilyData = f;

  const listEl = document.getElementById("familyList");
  listEl.innerHTML = "";

  const leader = f.leader || { id:"", name:"Leader", photo:"" };
  const members = Array.isArray(f.members) ? f.members : [];

  const isLeader = (String(leader.id) === String(user.id));

  document.getElementById("familyName").innerText = isLeader ? "Mening Oilam" : "Oila";
  document.getElementById("familyIdDisplay").innerText = "ID: " + leader.id;

  document.getElementById("leaveBtn").classList.toggle("hidden", isLeader);

  const avatarHtml = (photo, crown=false) => {
    let border = crown ? "border-yellow-500/50" : "border-gray-600";
    if (photo) return `<img src="${photo}" class="w-10 h-10 rounded-full object-cover border-2 ${border}" />`;
    return `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-300 border-2 ${border}">
              <i class="ph-bold ph-user leading-none"></i>
            </div>`;
  };

  // leader row
  const leaderRow = document.createElement("div");
  leaderRow.className = "flex items-center justify-between p-4 bg-gradient-to-r from-blue-900/30 to-transparent";
  leaderRow.innerHTML = `
    <div class="flex items-center gap-3">
      <div class="relative shrink-0">
        ${avatarHtml(leader.photo, true)}
        <div class="absolute -right-1 -bottom-1 w-5 h-5 rounded-full bg-yellow-500 flex items-center justify-center shadow-lg">
          <i class="ph-fill ph-crown text-black text-[10px] leading-none"></i>
        </div>
      </div>
      <div>
        <div class="font-bold text-white">${escapeHtml(leader.name)}</div>
        <div class="text-xs text-yellow-500/80 font-medium">Admin</div>
      </div>
    </div>
  `;
  listEl.appendChild(leaderRow);

  const S = UI[LANG] || UI.uz;

  if (!members.length) {
    const empty = document.createElement("div");
    empty.className = "p-6 text-center text-gray-500 text-sm";
    empty.innerText = S.empty_no_members;
    listEl.appendChild(empty);
    return;
  }

  for (const m of members) {
    const row = document.createElement("div");
    row.className = "flex items-center justify-between p-4 hover:bg-white/5 transition-colors";

    const actionBtn = isLeader ? `
      <button onclick="kickMember('${String(m.id)}')" class="w-8 h-8 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center shrink-0 border border-red-500/20 active:bg-red-500/20">
        <i class="ph-bold ph-trash leading-none"></i>
      </button>` : "";

    row.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="shrink-0">${avatarHtml(m.photo)}</div>
        <div>
          <div class="font-medium text-white">${escapeHtml(m.name || "User")}</div>
          <div class="text-xs text-gray-500 font-mono">ID: ${escapeHtml(String(m.id))}</div>
        </div>
      </div>
      ${actionBtn}
    `;
    listEl.appendChild(row);
  }
}

async function connectFamily(){
  const id=document.getElementById("connectId").value.trim();
  if(!id) return tg?.showAlert?.("ID raqamini yozing");
  if(id === String(user.id)) return tg?.showAlert?.("O'z IDingizni yozmang");

  const res = await api("/api/connect",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    targetId:id
  });

  if(res?.ok) tg?.showAlert?.("So'rov yuborildi ‚úÖ");
}

async function kickMember(targetId) {
  if(!confirm("Bu foydalanuvchini oiladan o'chirmoqchimisiz?")) return;

  const res = await api("/api/kick", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || "",
    targetId: String(targetId)
  });

  if(res?.ok) {
    tg?.showAlert?.("Foydalanuvchi o'chirildi");
    refreshFamily();
  }
}

async function confirmLeave(){
  if(!confirm("Rostan ham oiladan chiqmoqchisiz?")) return;

  const res = await api("/api/leave", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || ""
  });

  if(res?.ok) {
    tg?.showAlert?.("Siz oiladan chiqdingiz");
    location.reload();
  }
}

/** ---------------- SEND ---------------- */
async function sendMessage(){
  const text=document.getElementById("msg").value.trim();
  if(!text) return tg?.showAlert?.("Xabar yozing");

  const res = await api("/api/send",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    text
  });

  if(res?.ok) {
    tg?.showAlert?.("Xabar yuborildi! ‚úâÔ∏è");
    document.getElementById("msg").value="";
  }
}

function shareInvite(){
  const text=`ASik ilovasiga ulaning. Mening ID raqamim: ${user.id}`;
  const share = "https://t.me/share/url?text=" + encodeURIComponent(text);
  if(tg?.openTelegramLink) tg.openTelegramLink(share);
  else window.open(share, "_blank");
}

/** ---------------- SAFETY ---------------- */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/** ---------------- INITIAL LOAD ---------------- */
(function init() {
  if (!isTelegram) return;

  // skeleton first
  renderQuickStatsSkeleton();
  // load language then data
  loadLangFromServer().finally(() => {
    loadQuickStats();
  });
})();
</script>
</body>
</html>
