<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ASik App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
  :root {
    --bg-color: #000000;
    --card-bg: #1c1c1e;
    --card-bg-active: #2c2c2e;
    --primary: #0A84FF;
    --danger: #FF453A;
    --text-primary: #ffffff;
    --text-secondary: #8E8E93;
    --separator: #38383A;
    --radius: 16px;
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    margin: 0;
    padding-bottom: 90px;
  }

  .modern-input {
    background: var(--card-bg);
    border: 1px solid transparent;
    border-radius: 12px;
    padding: 16px;
    font-size: 17px;
    color: white;
    width: 100%;
    transition: all 0.2s ease;
    outline: none;
  }
  .modern-input:focus {
    background: var(--card-bg-active);
    border-color: var(--primary);
  }

  .glass-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }

  .btn-action {
    background: var(--primary);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.1s;
    border: none;
    width: 100%;
  }
  .btn-action:active { transform: scale(0.98); opacity: 0.9; }
  .btn-danger { background: var(--danger); }
  .btn-ghost { background: var(--card-bg-active); color: var(--primary); }

  .nav-bar {
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: rgba(28, 28, 30, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 10px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    border: 0.5px solid rgba(255,255,255,0.1);
    z-index: 100;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .nav-item {
    color: var(--text-secondary);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 500;
    padding: 8px;
    border-radius: 12px;
    background: transparent;
    border: none;
    transition: all 0.2s;
  }
  .nav-item i { font-size: 24px; margin-bottom: 2px; }
  .nav-item.active { color: var(--primary); background: rgba(10, 132, 255, 0.1); }

  .profile-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--card-bg-active);
    overflow: hidden;
    border: 2px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .list-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .list-row:last-child { border-bottom: none; }

  .hidden { display: none !important; }

  h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
  h2 { font-size: 20px; font-weight: 700; margin-bottom: 15px; }
  .subtitle { font-size: 13px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block;}
</style>
</head>
<body>

<div class="p-5 max-w-md mx-auto">

  <!-- HEADER -->
  <header class="flex justify-between items-center mb-6">
    <div>
      <div class="text-sm text-gray-400 font-medium mb-1">ASik</div>
      <h1>Xarajatlar</h1>
    </div>
    <div class="profile-avatar" onclick="openTab('family')">
      <img id="userAvatar" src="" alt="User" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'ph-bold ph-user\'></i>'">
    </div>
  </header>

  <!-- ADD EXPENSE -->
  <section id="tab-add" class="animate-fade">
    <div class="glass-card">
      <span class="subtitle">Yangi qo'shish</span>
      <div class="flex flex-col gap-3">
        <input id="amount" type="number" class="modern-input text-2xl font-bold" placeholder="0 so'm">
        <input id="cat" type="text" class="modern-input" placeholder="Nima olindi? (Non, Go'sht)">
        <button onclick="addExpense()" class="btn-action mt-2">
          <i class="ph-bold ph-plus"></i> Qo'shish
        </button>
      </div>
    </div>

    <div class="glass-card">
      <span class="subtitle">Bugungi holat</span>
      <div class="flex justify-between items-end">
        <div>
          <div class="text-gray-400 text-sm">Bugun sarflandi</div>
          <div id="quickStatsToday" class="text-2xl font-bold text-white mt-1">0</div>
        </div>
        <button onclick="openTab('stats')" class="text-blue-500 font-medium text-sm bg-transparent border-0">To'liq &rarr;</button>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="tab-stats" class="hidden">
    <div class="glass-card">
      <span class="subtitle">Umumiy hisobot</span>
      <div class="flex justify-between items-center mb-4">
        <span class="text-gray-400">Jami (Oy):</span>
        <span id="stMonth" class="text-2xl font-bold text-blue-500">0</span>
      </div>
      <div id="history" class="flex flex-col gap-1"></div>
    </div>

    <h2 class="mt-6 px-1">Tarix</h2>
    <div id="calendar" class="flex flex-col gap-3"></div>
  </section>

  <!-- FAMILY SETTINGS -->
  <section id="tab-family" class="hidden">
    <div class="glass-card text-center">
      <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 mx-auto flex items-center justify-center mb-3 text-3xl text-white">
        <i class="ph-bold ph-house"></i>
      </div>
      <h2 id="familyName" class="m-0 text-xl">Mening Oilam</h2>
      <div class="text-gray-400 text-sm mt-1" id="familyIdDisplay">ID: ...</div>
    </div>

    <div class="mb-2 px-1 flex justify-between items-end">
      <span class="subtitle mb-0">Ishtirokchilar</span>
    </div>

    <div class="glass-card p-0 overflow-hidden">
      <div id="familyList" class="divide-y divide-gray-800"></div>
    </div>

    <div class="glass-card">
      <span class="subtitle">Boshqaruv</span>
      <div class="flex flex-col gap-3">
        <div id="connectBlock">
          <p class="text-sm text-gray-400 mb-2">Boshqa oilaga qo'shilish uchun ID kiriting:</p>
          <div class="flex gap-2">
            <input id="connectId" type="number" class="modern-input py-2" placeholder="Oila ID">
            <button class="btn-action w-auto px-4" onclick="connectFamily()">
              <i class="ph-bold ph-arrow-right"></i>
            </button>
          </div>
        </div>

        <button class="btn-action btn-ghost w-full justify-center mt-2" onclick="shareInvite()">
          <i class="ph-bold ph-share-network"></i> Taklif havolasi
        </button>

        <button id="leaveBtn" class="btn-action btn-danger w-full justify-center hidden mt-2" onclick="confirmLeave()">
          <i class="ph-bold ph-sign-out"></i> Oiladan chiqish
        </button>
      </div>
    </div>
  </section>

  <!-- SEND MESSAGE -->
  <section id="tab-send" class="hidden">
    <div class="glass-card">
      <span class="subtitle">Xabar yuborish</span>
      <textarea id="msg" rows="4" class="modern-input mb-3" placeholder="Oila a'zolariga xabar qoldiring..."></textarea>
      <button class="btn-action" onclick="sendMessage()">
        <i class="ph-bold ph-paper-plane-right"></i> Yuborish
      </button>
    </div>
  </section>

</div>

<!-- NAVIGATION -->
<nav class="nav-bar">
  <button id="nav-add" class="nav-item active" onclick="openTab('add')">
    <i class="ph-fill ph-plus-circle"></i>
    <span>Qo'shish</span>
  </button>
  <button id="nav-stats" class="nav-item" onclick="openTab('stats')">
    <i class="ph-fill ph-chart-bar"></i>
    <span>Hisobot</span>
  </button>
  <button id="nav-send" class="nav-item" onclick="openTab('send')">
    <i class="ph-fill ph-chat-circle-text"></i>
    <span>Xabar</span>
  </button>
  <button id="nav-family" class="nav-item" onclick="openTab('family')">
    <i class="ph-fill ph-users-three"></i>
    <span>Oila</span>
  </button>
</nav>

<script>
/** ---------------- CONFIG / INIT ---------------- */
const tg = window.Telegram?.WebApp;
tg?.expand?.();
if (tg) {
  tg.setHeaderColor('#000000');
  tg.setBackgroundColor('#000000');
}

// Worker URL
const API_URL = "https://asik.windowsnoutbook.workers.dev";

// Telegram user or mock
const user = tg?.initDataUnsafe?.user || { id: "test_999", first_name: "Test", photo_url: "" };

// Avatar
const avatarEl = document.getElementById("userAvatar");
if (user.photo_url) avatarEl.src = user.photo_url;
else {
  avatarEl.style.display = "none";
  avatarEl.parentElement.innerHTML = '<i class="ph-bold ph-user text-white text-xl"></i>';
}

let currentFamilyData = null;
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

/** ---------------- STABLE API ---------------- */
async function api(path, body, { timeoutMs = 12000, retries = 1 } = {}) {
  const btns = document.querySelectorAll("button");
  btns.forEach(b => b.style.opacity = "0.7");

  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try {
    let lastErr = null;

    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        const r = await fetch(API_URL + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
          signal: controller.signal
        });

        const text = await r.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch { data = { ok:false, error:"non_json", raw:text }; }

        if (!r.ok) {
          const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${r.status}`;
          throw new Error(msg);
        }
        return data;
      } catch (e) {
        lastErr = e;
        if (attempt < retries) { await sleep(350 * (attempt + 1)); continue; }
        throw lastErr;
      }
    }
  } catch (e) {
    const msg = e?.name === "AbortError" ? "Timeout. Worker javob bermadi." : (e.message || "Unknown error");
    tg?.showAlert?.("Xatolik: " + msg);
    return null;
  } finally {
    clearTimeout(timer);
    btns.forEach(b => b.style.opacity = "1");
  }
}

/** ---------------- NAVIGATION ---------------- */
function openTab(n){
  ["add","stats","send","family"].forEach(t=>{
    document.getElementById("tab-"+t).classList.toggle("hidden",t!==n);
    document.getElementById("nav-"+t)?.classList?.toggle("active",t===n);
  });

  const titles = { add: "Xarajatlar", stats: "Hisobot", send: "Xat yozish", family: "Oila Sozlamalari" };
  document.querySelector("h1").innerText = titles[n] || "Family Hub";

  if(n==="stats") loadStats();
  if(n==="family") refreshFamily();
  if(n==="add") loadQuickStats();

  window.scrollTo({top: 0, behavior: "smooth"});
}

/** ---------------- ADD ---------------- */
async function addExpense(){
  const amt=document.getElementById("amount").value.trim();
  const cat=document.getElementById("cat").value.trim()||"Boshqa";
  if(!amt) return tg?.showAlert?.("Summani kiriting!");

  const res = await api("/api/add",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    amount:amt,
    cat
  });

  if(!res?.ok) return;

  tg?.HapticFeedback?.notificationOccurred?.("success");
  tg?.showAlert?.("✅ Saqlandi");

  document.getElementById("amount").value="";
  document.getElementById("cat").value="";
  loadQuickStats();
}

async function loadQuickStats() {
  const data = await api("/api/stats",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });

  const now = new Date();
  let today = 0;
  if(Array.isArray(data)) {
    for (const x of data) {
      const ts = Number(x.createdAt || x.id);
      if (!ts) continue;
      const d = new Date(ts);
      if(d.toDateString() === now.toDateString()) today += (Number(x.amount)||0);
    }
  }
  document.getElementById("quickStatsToday").innerText = today.toLocaleString() + " so'm";
}

/** ---------------- STATS ---------------- */
async function loadStats(){
  const data = await api("/api/stats",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });

  const now = new Date();
  let month = 0;

  const history = document.getElementById("history");
  const calendar = document.getElementById("calendar");
  history.innerHTML = ""; calendar.innerHTML = "";

  if(!Array.isArray(data) || !data.length) {
    history.innerHTML = "<div class='text-center text-gray-500 py-4'>Hozircha xarajat yo'q</div>";
    document.getElementById("stMonth").innerText = "0 so'm";
    return;
  }

  data.sort((a,b)=>Number(b.id)-Number(a.id));
  const byDate={};

  data.slice(0, 5).forEach(x => {
    const d = new Date(Number(x.createdAt || x.id));
    const div = document.createElement("div");
    div.className = "list-row";
    div.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-blue-500">
          <i class="ph-bold ph-shopping-bag"></i>
        </div>
        <div>
          <div class="font-semibold text-sm">${escapeHtml(x.cat || "noma'lum")}</div>
          <div class="text-xs text-gray-500">${escapeHtml(x.name || "User")} • ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</div>
        </div>
      </div>
      <div class="font-bold text-white">${Number(x.amount||0).toLocaleString()}</div>
    `;
    history.appendChild(div);
  });

  for(const x of data){
    const d=new Date(Number(x.createdAt||x.id));
    const key=d.toISOString().split("T")[0];
    const amount=Number(x.amount)||0;

    if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()) month+=amount;

    if(!byDate[key]) byDate[key]=[];
    byDate[key].push(x);
  }

  const days = Object.keys(byDate).sort((a,b)=>a<b?1:-1);
  for(const day of days){
    const block=document.createElement("div");
    block.className="glass-card !p-4";

    const d=new Date(day+"T00:00:00");
    let sum=0;
    byDate[day].forEach(x=>sum+=Number(x.amount)||0);

    let html=`<div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700">
      <span class="font-bold text-gray-300">${d.toLocaleDateString()}</span>
      <span class="text-blue-400 font-bold">${sum.toLocaleString()}</span>
    </div>`;

    for(const x of byDate[day]){
      html+=`<div class="flex justify-between text-sm mb-2 last:mb-0">
        <span class="text-gray-400">${escapeHtml(x.cat || "noma'lum")}
          <span class="text-xs opacity-50">(${escapeHtml(x.name || "")})</span>
        </span>
        <span>${Number(x.amount||0).toLocaleString()}</span>
      </div>`;
    }
    block.innerHTML=html;
    calendar.appendChild(block);
  }

  document.getElementById("stMonth").innerText = month.toLocaleString() + " so'm";
}

/** ---------------- FAMILY (name + photo) ---------------- */
async function refreshFamily(){
  const f = await api("/api/family",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || ""
  });
  if (!f) return;

  currentFamilyData = f;

  const listEl = document.getElementById("familyList");
  listEl.innerHTML = "";

  const leader = f.leader || { id:"", name:"Leader", photo:"" };
  const members = Array.isArray(f.members) ? f.members : [];

  const isLeader = (String(leader.id) === String(user.id));

  document.getElementById("familyName").innerText = isLeader ? "Mening Oilam" : "Oila";
  document.getElementById("familyIdDisplay").innerText = "Oila ID: " + leader.id;

  document.getElementById("leaveBtn").classList.toggle("hidden", isLeader);

  const avatarHtml = (photo) => {
    if (photo) return `<img src="${photo}" class="w-10 h-10 rounded-full object-cover" />`;
    return `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-300">
              <i class="ph-bold ph-user"></i>
            </div>`;
  };

  // leader row
  const leaderRow = document.createElement("div");
  leaderRow.className = "flex items-center justify-between p-4 bg-blue-900/20";
  leaderRow.innerHTML = `
    <div class="flex items-center gap-3">
      <div class="relative">
        ${avatarHtml(leader.photo)}
        <div class="absolute -right-1 -bottom-1 w-5 h-5 rounded-full bg-yellow-500 flex items-center justify-center">
          <i class="ph-fill ph-crown text-black text-xs"></i>
        </div>
      </div>
      <div>
        <div class="font-bold text-white">${escapeHtml(leader.name)} <span class="text-xs text-gray-400">(ID: ${escapeHtml(leader.id)})</span></div>
        <div class="text-xs text-gray-400">Admin</div>
      </div>
    </div>
  `;
  listEl.appendChild(leaderRow);

  if (!members.length) {
    const empty = document.createElement("div");
    empty.className = "p-4 text-center text-gray-500 text-sm";
    empty.innerText = "Boshqa ishtirokchilar yo'q";
    listEl.appendChild(empty);
    return;
  }

  for (const m of members) {
    const row = document.createElement("div");
    row.className = "flex items-center justify-between p-4";

    const actionBtn = isLeader ? `
      <button onclick="kickMember('${String(m.id)}')" class="w-8 h-8 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center">
        <i class="ph-bold ph-trash"></i>
      </button>` : "";

    row.innerHTML = `
      <div class="flex items-center gap-3">
        ${avatarHtml(m.photo)}
        <div>
          <div class="font-medium text-white">${escapeHtml(m.name || "User")}</div>
          <div class="text-xs text-gray-500">ID: ${escapeHtml(String(m.id))}</div>
        </div>
      </div>
      ${actionBtn}
    `;
    listEl.appendChild(row);
  }
}

async function connectFamily(){
  const id=document.getElementById("connectId").value.trim();
  if(!id) return tg?.showAlert?.("ID raqamini yozing");
  if(id === String(user.id)) return tg?.showAlert?.("O'z IDingizni yozmang");

  const res = await api("/api/connect",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    targetId:id
  });
  if(res?.ok) tg?.showAlert?.("So'rov yuborildi ✅");
}

async function kickMember(targetId) {
  if(!confirm("Bu foydalanuvchini oiladan o'chirmoqchimisiz?")) return;

  const res = await api("/api/kick", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || "",
    targetId: String(targetId)
  });

  if(res?.ok) {
    tg?.showAlert?.("Foydalanuvchi o'chirildi");
    refreshFamily();
  } else {
    tg?.showAlert?.("Xatolik: " + (res?.error || "Ruxsat yo'q"));
  }
}

async function confirmLeave(){
  if(!confirm("Rostan ham oiladan chiqmoqchimisiz?")) return;

  const res = await api("/api/leave", {
    userId: String(user.id),
    userName: user.first_name,
    userPhoto: user.photo_url || ""
  });

  if(res?.ok) {
    tg?.showAlert?.("Siz oiladan chiqdingiz");
    location.reload();
  }
}

/** ---------------- SEND ---------------- */
async function sendMessage(){
  const text=document.getElementById("msg").value.trim();
  if(!text) return tg?.showAlert?.("Xabar yozing");

  const res = await api("/api/send",{
    userId:String(user.id),
    userName:user.first_name,
    userPhoto: user.photo_url || "",
    text
  });

  if(res?.ok) {
    tg?.showAlert?.("Xabar yuborildi! ✉️");
    document.getElementById("msg").value="";
  }
}

function shareInvite(){
  const text=`ASik ilovasiga ulaning. Mening ID raqamim: ${user.id}`;
  const share = "https://t.me/share/url?text=" + encodeURIComponent(text);
  if(tg?.openTelegramLink) tg.openTelegramLink(share);
  else window.open(share, "_blank");
}

/** ---------------- SAFETY ---------------- */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// Initial load
loadQuickStats();
</script>
</body>
</html>
